import{Q as be,e as f,R as _,U as oe,V,W as Ce}from"./chunk-vendor.js";import{E as N,H as ve,s as Se,D as L,V as $,R as T,S as ae,k as K,a as W,W as Ee,b as ke,c as xe,m as Le,L as O,j as re,h as ce,d as le,y as Pe,x as $e,e as Te,f as Me,C as j,A as Fe,g as Ie,v as De,i as Ne,l as Re,n as Ae}from"./chunk-codemirror.js";import{F as _e,g as E,i as J}from"./chunk-git.js";import{c as Oe}from"./chunk-gpt-tokenizer.js";import{e as F}from"./chunk-eruda.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();var de=!1;try{var B={};Object.defineProperty(B,"passive",{get(){return de=!0,!1}}),window.addEventListener("testpassive",null,B),window.removeEventListener("testpassive",null,B)}catch{}if(de){var Be=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(o,e,t){var s=t&&typeof t=="object",n=s?t.capture:t,i=s?Object.assign({},t):{};return i.passive===void 0&&(o==="touchstart"||o==="touchmove"||o==="wheel")&&(i.passive=!0),i.capture===void 0&&(i.capture=!!n),Be.call(this,o,e,i)}}class Y{constructor({targetSelector:e,items:t,containerItems:s=[],itemSelector:n,dataAttribute:i}){if(this.targetSelector=e,this.items=t,this.containerItems=s,this.itemSelector=n,i){const a=i.replace("data-","");this.dataAttributeKey=a.replace(/-([a-z])/g,r=>r[1].toUpperCase())}else this.dataAttributeKey=null;this.menuElement=null,this.longPressTimeout=null,this.boundHideMenu=this.hideMenu.bind(this),this.init()}init(){this.createMenuElement(),document.addEventListener("contextmenu",this.handleContextMenu.bind(this)),document.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),document.addEventListener("touchend",this.handleTouchEnd.bind(this)),document.addEventListener("touchcancel",this.handleTouchEnd.bind(this))}createMenuElement(){this.menuElement=document.createElement("div"),this.menuElement.className="context-menu",document.body.appendChild(this.menuElement)}handleContextMenu(e){const t=e.target.closest(this.targetSelector);if(!t)return;e.preventDefault();const s=this.itemSelector?e.target.closest(this.itemSelector):null;s?this.showMenu(e.clientX,e.clientY,this.items,s):this.showMenu(e.clientX,e.clientY,this.containerItems,t)}handleTouchStart(e){const t=e.target.closest(this.targetSelector);t&&(this.longPressTimeout=setTimeout(()=>{e.preventDefault();const s=this.itemSelector?e.target.closest(this.itemSelector):null,n=s?this.items:this.containerItems;this.showMenu(e.touches[0].clientX,e.touches[0].clientY,n,s||t),this.longPressTimeout=null},500))}handleTouchEnd(){this.longPressTimeout&&(clearTimeout(this.longPressTimeout),this.longPressTimeout=null)}showMenu(e,t,s,n){this.menuElement.innerHTML="",this.menuElement.style.display="block";const i=this.dataAttributeKey&&n.dataset[this.dataAttributeKey]?n.dataset[this.dataAttributeKey]:null;s.forEach(u=>{if(u.type==="separator"){const m=document.createElement("div");m.className="context-menu-separator",this.menuElement.appendChild(m);return}const g=document.createElement("button");g.className="context-menu-item",g.textContent=u.label,g.addEventListener("click",()=>{u.action(i),this.hideMenu()}),this.menuElement.appendChild(g)});const a=this.menuElement.offsetWidth,r=this.menuElement.offsetHeight,{innerWidth:c,innerHeight:l}=window;let d=e,h=t;e+a>c&&(d=c-a-5),t+r>l&&(h=l-r-5),this.menuElement.style.top=`${h}px`,this.menuElement.style.left=`${d}px`,document.addEventListener("click",this.boundHideMenu),document.addEventListener("contextmenu",this.boundHideMenu)}hideMenu(e){e&&this.menuElement.contains(e.target)||this.menuElement.style.display==="block"&&(this.menuElement.style.display="none",document.removeEventListener("click",this.boundHideMenu),document.removeEventListener("contextmenu",this.boundHideMenu))}}class b{constructor({title:e="Notice"}={}){this.overlay=document.createElement("div"),this.overlay.className="modal-overlay hidden",this.container=document.createElement("div"),this.container.className="modal-container",this.header=document.createElement("div"),this.header.className="modal-header",this.header.textContent=e,this.content=document.createElement("div"),this.content.className="modal-content",this.content.innerHTML="Loading...",this.footer=document.createElement("div"),this.footer.className="modal-footer",this.footer.style.display="none",this.container.appendChild(this.header),this.container.appendChild(this.content),this.container.appendChild(this.footer),this.overlay.appendChild(this.container),document.body.appendChild(this.overlay)}show(){this.overlay.classList.remove("hidden")}hide(){this.overlay.classList.add("hidden")}destroy(){this.overlay.parentNode&&this.overlay.remove()}updateContent(e){this.content.innerHTML=e}addFooterButton(e,t){this.footer.style.display="flex";const s=document.createElement("button");return s.textContent=e,s.addEventListener("click",t),this.footer.appendChild(s),s}clearFooter(){this.footer.innerHTML="",this.footer.style.display="none"}static prompt({title:e,label:t,defaultValue:s=""}){return new Promise(n=>{const i=new b({title:e}),a=`modal-input-${Date.now()}`,r=`
        <div class="modal-prompt">
          <label for="${a}">${t}</label>
          <input type="text" id="${a}" value="${s}">
        </div>
      `;i.updateContent(r);const c=i.content.querySelector(`#${a}`),l=()=>{n(c.value),i.destroy()},d=()=>{n(null),i.destroy()};c.addEventListener("keydown",h=>{h.key==="Enter"?(h.preventDefault(),l()):h.key==="Escape"&&d()}),i.addFooterButton("OK",l),i.addFooterButton("Cancel",d),i.show(),c.focus(),c.select()})}static confirm({title:e,message:t,okText:s="OK",cancelText:n="Cancel",destructive:i=!1}){return new Promise(a=>{const r=new b({title:e});r.updateContent(`<p>${t}</p>`);const c=()=>{a(!0),r.destroy()},l=()=>{a(!1),r.destroy()},d=r.addFooterButton(s,c);i&&d.classList.add("destructive"),r.addFooterButton(n,l),r.show()})}static choice({title:e,message:t,choices:s}){return new Promise(n=>{const i=new b({title:e});i.updateContent(t),s.forEach(r=>{const c=i.addFooterButton(r.text,()=>{n(r.id),i.destroy()});r.class&&c.classList.add(r.class)});const a=r=>{r.key==="Escape"&&(n(null),i.destroy(),document.removeEventListener("keydown",a))};document.addEventListener("keydown",a),i.show()})}static selection({title:e,peerData:t,okText:s="Request"}){return new Promise(n=>{if(t.size===0){const l=new b({title:"No Peers Found"});l.updateContent("<p>There are no other peers currently connected to this sync session.</p>"),l.addFooterButton("OK",()=>{l.destroy(),n(null)}),l.show();return}const i=new b({title:e});let a='<div class="peer-selection-container">';t.forEach((l,d)=>{const h=d.substring(0,8);a+=`
          <div class="peer-group" data-peer-id="${d}">
            <strong class="peer-title">Peer: ${h}...</strong>
            <div class="garden-checkbox-list">
              ${l.gardens.map(u=>`
                <label>
                  <input type="checkbox" class="garden-select-checkbox" value="${u}">
                  <span>${u}</span>
                </label>
              `).join("")}
            </div>
          </div>
        `}),a+="</div>",i.updateContent(a);const r=()=>{const l={};i.content.querySelectorAll(".peer-group").forEach(d=>{const h=d.dataset.peerId,u=Array.from(d.querySelectorAll(".garden-select-checkbox:checked")).map(g=>g.value);u.length>0&&(l[h]=u)}),n(Object.keys(l).length>0?l:null),i.destroy()},c=()=>{n(null),i.destroy()};i.addFooterButton(s,r),i.addFooterButton("Cancel",c),i.show()})}}const Ue={async renderFiles(o){try{const e=await this.listFiles(this.gitClient,"/"),t=new Map;for(const[i,a,r]of o)a!==r&&t.set(`/${i}`,"modified");const s=decodeURIComponent(window.location.hash.substring(1)),n=e.sort().map(i=>{const a=`#${i}`,r=t.get(i)||"unmodified",c=i.startsWith("/")?i.substring(1):i,l=[`status-${r}`];return i===s&&l.push("active"),`<li><a href="${a}" class="${l.join(" ")}" data-filepath="${i}">${c}</a></li>`}).join("");this.contentContainer.innerHTML=`<ul>${n}</ul>`}catch(e){console.error("Error rendering file list:",e),this.contentContainer.innerHTML='<p class="sidebar-error">Could not load files.</p>'}},async handleNewFile(){const o=await b.prompt({title:"New File",label:"Enter new file name:"});if(!o)return;const e=`/${o}`;try{await this.gitClient.pfs.stat(e),await this.showAlert({title:"File Exists",message:`File "${o}" already exists.`})}catch(t){t.code==="ENOENT"?(await this.gitClient.writeFile(e,""),window.location.hash=`#${e}`):(console.error("Error checking for file:",t),await this.showAlert({title:"Error",message:"An error occurred while creating the file."}))}},async handleRename(o){const e=await b.prompt({title:"Rename File",label:`Enter new name for ${o.substring(1)}:`,defaultValue:o.substring(1)});if(!e||e===o.substring(1))return;const t=`/${e}`;try{const s=t.substring(0,t.lastIndexOf("/"));s&&await this.ensureDir(s),await this.gitClient.pfs.rename(o,t),decodeURIComponent(window.location.hash)===`#${o}`?window.location.hash=`#${t}`:await this.refresh()}catch(s){console.error("Error renaming file:",s),await this.showAlert({title:"Error",message:"Failed to rename file. Check console for details."})}},async handleDuplicate(o){const e=o.substring(0,o.lastIndexOf("/")),t=o.substring(o.lastIndexOf("/")+1),s=t.lastIndexOf("."),n=s>0;let i;if(n){const c=t.substring(0,s),l=t.substring(s);i=`${c} (copy)${l}`}else i=`${t} (copy)`;const a=await b.prompt({title:"Duplicate File",label:"Enter name for duplicated file:",defaultValue:i});if(!a)return;const r=`${e}/${a}`;try{const c=await this.gitClient.readFile(o);await this.gitClient.writeFile(r,c),await this.refresh()}catch(c){console.error("Error duplicating file:",c),await this.showAlert({title:"Error",message:"Failed to duplicate file."})}},async handleDelete(o){if(await this.showConfirm({title:"Delete File",message:`Are you sure you want to permanently delete "${o}"? This cannot be undone.`,okText:"Delete",destructive:!0}))try{const t=decodeURIComponent(window.location.hash)===`#${o}`;await this.gitClient.pfs.unlink(o),t?window.location.hash="#/home":await this.refresh()}catch(t){console.error("Error deleting file:",t),await this.showAlert({title:"Error",message:"Failed to delete file."})}}};class P{constructor(e){if(!e)throw new Error("A garden name is required to initialize the Git client.");this.gardenName=e,this.fs=new _e(`garden-fs-${this.gardenName}`),this.pfs=this.fs.promises}async initRepo(){try{await this.pfs.stat("/.git"),this.registerNewGarden();return}catch{}console.log(`Initializing new garden: "${this.gardenName}"...`);try{await E.init({fs:this.fs,dir:"/",defaultBranch:"main"});const e=`# Welcome to your new garden: ${this.gardenName}

Start writing your thoughts here.`;await this.pfs.writeFile("/home",e,"utf8"),this.registerNewGarden(),console.log("New garden initialized successfully.")}catch(e){console.error("Error initializing repository:",e)}}registerNewGarden(){try{const e=localStorage.getItem("thoughtform_gardens"),t=e?JSON.parse(e):[];t.includes(this.gardenName)||(t.push(this.gardenName),localStorage.setItem("thoughtform_gardens",JSON.stringify(t)))}catch(e){console.error("Failed to update garden registry:",e)}}async rmrf(e){try{if((await this.pfs.stat(e)).isDirectory()){const s=await this.pfs.readdir(e);for(const n of s)await this.rmrf(`${e}/${n}`);await this.pfs.rmdir(e)}else await this.pfs.unlink(e)}catch(t){if(t.code!=="ENOENT")throw console.error(`Error during rmrf for ${e}:`,t),t}}async clearWorkdir(){const e=await this.pfs.readdir("/");for(const t of e)t!==".git"&&await this.rmrf(`/${t}`)}async ensureDir(e){const t=e.split("/").filter(n=>n);let s="";for(const n of t){s+=`/${n}`;try{await this.pfs.stat(s)}catch(i){if(i.code==="ENOENT")try{await this.pfs.mkdir(s)}catch(a){if(a.code!=="EEXIST")throw a}else throw i}}}async listAllFilesForClone(e="/"){let t=[];const s=await this.pfs.readdir(e);for(const n of s){const i=`${e==="/"?"":e}/${n}`;(await this.pfs.stat(i)).isDirectory()?t=t.concat(await this.listAllFilesForClone(i)):t.push(i)}return t}async stage(e){const t=e.startsWith("/")?e.substring(1):e,n=(await this.getStatuses()).find(a=>a[0]===t);if(!n){console.error(`Could not find status for "${t}". Cannot stage.`);return}n[2]===0?await E.remove({fs:this.fs,dir:"/",filepath:t}):await E.add({fs:this.fs,dir:"/",filepath:t})}async unstage(e){const t=e.startsWith("/")?e.substring(1):e;await E.remove({fs:this.fs,dir:"/",filepath:t})}async discard(e){const t=e.startsWith("/")?e.substring(1):e;try{const n=(await this.getStatuses()).find(a=>a[0]===t);if(!n)return;n[1]===0?await this.pfs.unlink(e):await E.checkout({fs:this.fs,dir:"/",filepaths:[t],force:!0})}catch(s){console.error(`[discard] An error occurred for ${e}:`,s)}}async commit(e){const t=await E.commit({fs:this.fs,dir:"/",message:e,author:{name:"User",email:"user@thoughtform.garden"}});return this.markGardenAsDirty(!1),t}async push(e,t,s){return await E.push({fs:this.fs,http:J,dir:"/",url:e,onProgress:n=>s(`${n.phase}: ${n.loaded}/${n.total}`),onAuth:()=>({username:t})})}async pull(e,t,s){return await E.pull({fs:this.fs,http:J,dir:"/",url:e,onProgress:n=>s(`${n.phase}: ${n.loaded}/${n.total}`),onAuth:()=>({username:t}),author:{name:"User",email:"user@thoughtform.garden"},singleBranch:!0,fastForward:!0})}async log(){try{return await E.log({fs:this.fs,dir:"/",depth:20})}catch{return[]}}async getChangedFiles(e){try{const{commit:t}=await E.readCommit({fs:this.fs,dir:"/",oid:e}),s=t.parent[0];if(!s)return(await E.listFiles({fs:this.fs,dir:"/",ref:e})).map(i=>`/${i}`);const n=[];return await E.walk({fs:this.fs,dir:"/",trees:[E.TREE({ref:s}),E.TREE({ref:e})],map:async(i,[a,r])=>{if(i===".")return;const c=a&&await a.oid(),l=r&&await r.oid();if(c===l)return;(r?await r.type():await a.type())==="blob"&&n.push(`/${i}`)}}),n}catch(t){return console.error(`Error getting changed files for commit ${e}:`,t),[]}}async readBlob(e){return this.readBlobFromCommit("HEAD",e)}async readBlobFromCommit(e,t){const s=t.startsWith("/")?t.substring(1):t;if(!e)return"";try{const n=e==="HEAD"?await E.resolveRef({fs:this.fs,dir:"/",ref:"HEAD"}):e,{blob:i}=await E.readBlob({fs:this.fs,dir:"/",oid:n,filepath:s});return new TextDecoder().decode(i)}catch(n){return n.name==="NotFoundError"?"":null}}async readFile(e){try{return await this.pfs.readFile(e,"utf8")}catch{return`// "${e}" does not exist yet, type anywhere to create it.`}}async readFileAsBuffer(e){try{return await this.pfs.readFile(e)}catch{return null}}async writeFile(e,t){const s=typeof t=="string"?"utf8":void 0;try{await this.pfs.writeFile(e,t,s),this.markGardenAsDirty(!0)}catch(n){if(n.code==="ENOENT"){const i=e.substring(0,e.lastIndexOf("/"));if(i&&i!=="/")try{await this.ensureDir(i),await this.pfs.writeFile(e,t,s),this.markGardenAsDirty(!0)}catch(a){throw a}else throw n}else throw n}}markGardenAsDirty(e){try{const t=localStorage.getItem("dirty_gardens"),s=t?JSON.parse(t):[],n=s.indexOf(this.gardenName);e&&n===-1?s.push(this.gardenName):!e&&n!==-1&&s.splice(n,1),localStorage.setItem("dirty_gardens",JSON.stringify(s))}catch(t){console.error("Failed to update dirty garden registry:",t)}}async getStatuses(){return E.statusMatrix({fs:this.fs,dir:"/"})}}const qe={async renderGardens(){try{const o=localStorage.getItem("thoughtform_gardens"),e=o?JSON.parse(o):[],t=localStorage.getItem("dirty_gardens"),s=t?new Set(JSON.parse(t||"[]")):new Set;if(e.length===0){this.contentContainer.innerHTML='<p class="sidebar-info">No gardens found. Create one!</p>';return}let n="";for(const i of e.sort()){const a=decodeURIComponent(i),r=s.has(a),c=`/${encodeURIComponent(i)}`,l=this.gitClient.gardenName===a,d=[];l&&d.push("active"),r&&d.push("status-modified"),n+=`<li><a href="${c}" class="${d.join(" ")}" data-garden-name="${i}">${a}</a></li>`}this.contentContainer.innerHTML=`<ul>${n}</ul>`,this.contentContainer.querySelectorAll("[data-garden-name]").forEach(i=>{i.addEventListener("click",a=>{this.gitClient.gardenName!==a.target.dataset.gardenName&&sessionStorage.setItem("sidebarActiveTab","Files")})})}catch(o){console.error("Error rendering garden list:",o),this.contentContainer.innerHTML='<p class="sidebar-error">Could not load gardens.</p>'}},async handleNewGarden(){const o=await b.prompt({title:"New Garden",label:"Enter new garden name:"});if(!o||!o.trim())return;const e=localStorage.getItem("thoughtform_gardens");if((e?JSON.parse(e):[]).includes(o)){await this.showAlert({title:"Garden Exists",message:`Garden "${o}" already exists.`});return}sessionStorage.setItem("sidebarActiveTab","Files"),window.location.pathname=`/${encodeURIComponent(o)}`},async handleDuplicateGarden(o){if(!o)return;const t=`${decodeURIComponent(o)} (copy)`,s=await b.prompt({title:"Duplicate Garden",label:"Enter name for new garden:",defaultValue:t});if(!s||!s.trim()||s===o)return;const n=this.contentContainer.innerHTML;this.contentContainer.innerHTML='<p class="sidebar-info">Preparing duplication...<br>(UI may be unresponsive)</p>',setTimeout(async()=>{try{const i=new P(o),a=new P(s);await a.initRepo();const r=await this.listFiles(i,"/");let c=0;for(const l of r){c++,this.contentContainer.innerHTML=`<p class="sidebar-info">Copying file ${c} of ${r.length}:<br>${l.substring(1)}</p>`;const d=await i.readFile(l);await a.writeFile(l,d)}sessionStorage.setItem("sidebarActiveTab","Files"),this.contentContainer.innerHTML='<p class="sidebar-info">Duplication complete. Redirecting...</p>',setTimeout(()=>{window.location.replace(`/${encodeURIComponent(s)}`)},500)}catch(i){console.error("Error duplicating garden:",i),await this.showAlert({title:"Error",message:"Failed to duplicate garden. Check console for details."}),this.contentContainer.innerHTML=n}},100)},async handleDeleteGarden(o){if(!o)return;if(o==="home"){await this.showAlert({title:"Action Not Allowed",message:'The default "home" garden cannot be deleted.'});return}if(await this.showConfirm({title:"Delete Garden",message:`ARE YOU SURE you want to permanently delete the garden "${o}"? This cannot be undone.`,okText:"Delete",destructive:!0}))try{const t=localStorage.getItem("thoughtform_gardens");let s=t?JSON.parse(t):[];s=s.filter(i=>i!==o),localStorage.setItem("thoughtform_gardens",JSON.stringify(s));const n=`garden-fs-${o}`;await new Promise((i,a)=>{const r=indexedDB.deleteDatabase(n);r.onsuccess=()=>i(),r.onerror=c=>a(c.target.error),r.onblocked=()=>{this.showAlert({title:"Deletion Blocked",message:"Could not delete the database because it's still in use. Please refresh the page and try again."}),a(new Error("Deletion blocked"))}}),this.gitClient.gardenName===o?(sessionStorage.setItem("sidebarActiveTab","Files"),window.location.pathname="/home"):await this.refresh()}catch(t){console.error("Error deleting garden:",t),t.message!=="Deletion blocked"&&await this.showAlert({title:"Error",message:"Failed to delete garden."})}}},Ge={async renderGitView(){try{const[o,e]=await Promise.all([this.gitClient.getStatuses(),this.gitClient.log()]),t=[],s=[];for(const[h,u,g,m]of o){const y=`/${h}`;(u!==g||u!==m)&&(g===m?t.push({filepath:y,status:"staged"}):s.push({filepath:y,status:"unstaged"}))}const n=this.renderRemoteSection(),i=`
        <div class="git-commit-area">
          <textarea id="git-commit-message" placeholder="Commit message..." rows="3"></textarea>
          <button id="git-commit-button" disabled>Commit</button>
        </div>
      `,a=this.renderFileSection("Changes",s,!1),r=this.renderFileSection("Staged Changes",t,!0),c=this.renderHistorySection(e),l=this.contentContainer.querySelector("#git-commit-message")?.value||"";this.contentContainer.innerHTML=`
        <div class="git-view-container">
          ${n}
          ${i}
          ${r}
          ${a}
          ${c}
        </div>
      `;const d=this.contentContainer.querySelector("#git-commit-message");d&&(d.value=l),this.addGitViewListeners(),this.updateCommitButtonState()}catch(o){console.error("Error rendering Git view:",o),this.contentContainer.innerHTML='<p class="sidebar-error">Could not load Git status.</p>'}},renderRemoteSection(){const o=this.getRemoteConfig();return`
      <div class="git-remote-section">
        <h3>Remote</h3>
        <input type="text" id="git-remote-url" placeholder="Remote URL" value="${o.url}">
        <input type="password" id="git-remote-auth" placeholder="Username or Token" value="${o.auth}">
        <div class="git-remote-actions">
          <button id="git-pull-button">Pull</button>
          <button id="git-push-button">Push</button>
        </div>
        <div class="git-remote-log" id="git-remote-log">Ready</div>
      </div>
    `},renderFileSection(o,e,t){const s=t?'<button class="git-action-button unstage" title="Unstage Changes">-</button>':'<button class="git-action-button stage" title="Stage Changes">+</button>';let n="";return e.length>0?n=e.map(a=>{const r=a.filepath.startsWith("/")?a.filepath.substring(1):a.filepath;return`
          <li class="git-file-item ${this.editor.filePath===a.filepath?"active":""}" data-filepath="${a.filepath}">
            <span class="git-file-path">${r}</span>
            <span class="git-file-actions">
              <button class="git-action-button discard" title="Discard Changes">⭯</button>
              ${s}
            </span>
          </li>
        `}).join(""):n=`<li><span class="no-changes">No ${t?"staged ":""}changes.</span></li>`,`
      <div class="git-file-section ${t?"git-staged-section":""}">
        <h3 class="git-section-header">${o} (${e.length})</h3>
        <ul class="git-file-list">
          ${n}
        </ul>
      </div>
    `},renderHistorySection(o){let e="";return o.length>0?e=o.map(t=>{const s=t.commit.message.split(`
`)[0],n=t.oid.substring(0,7),i=t.commit.author.name,a=new Date(t.commit.author.timestamp*1e3).toLocaleString(),r=t.commit.parent[0]||"";return`
              <li class="git-history-item" data-oid="${t.oid}" data-parent-oid="${r}" data-author="${i}" data-date="${a}">
                <div class="git-history-header">
                  <span class="git-history-message">${s}</span>
                  <span class="git-history-oid">${n}</span>
                </div>
                <div class="git-history-details" style="display: none;"></div>
              </li>
            `}).join(""):e='<li><span class="no-changes">No commit history.</span></li>',`
        <div class="git-history-section">
            <h3 class="git-section-header">History</h3>
            <ul class="git-history-list">
                ${e}
            </ul>
        </div>
    `},updateCommitButtonState(){const o=this.contentContainer.querySelector("#git-commit-message"),e=this.contentContainer.querySelector("#git-commit-button");if(!o||!e)return;const t=this.contentContainer.querySelector(".git-staged-section .git-file-item")!==null,s=o.value.trim().length>0;e.disabled=!(t&&s)},getRemoteConfig(){const o=`thoughtform_remote_config_${this.gitClient.gardenName}`;try{const e=localStorage.getItem(o);if(e)return JSON.parse(e)}catch(e){console.error("Could not parse remote config from localStorage",e)}return{url:"",auth:""}},saveRemoteConfig(o,e){const t=`thoughtform_remote_config_${this.gitClient.gardenName}`,s={url:o,auth:e};localStorage.setItem(t,JSON.stringify(s))},addGitViewListeners(){const o=this.contentContainer.querySelector("#git-remote-url"),e=this.contentContainer.querySelector("#git-remote-auth"),t=this.contentContainer.querySelector("#git-push-button"),s=this.contentContainer.querySelector("#git-pull-button"),n=this.contentContainer.querySelector("#git-remote-log"),i=()=>{this.saveRemoteConfig(o.value,e.value)};o.addEventListener("input",i),e.addEventListener("input",i);const a=async d=>{const h=o.value.trim(),u=e.value.trim();if(!h){n.textContent="Error: Remote URL is required.";return}t.disabled=!0,s.disabled=!0;const g=d==="push"?"Pushing":"Pulling";n.textContent=`${g} to ${h}...`;try{const m=await this.gitClient[d](h,u,y=>{n.textContent=y});m.ok?n.textContent=`${g} complete.`:n.textContent=`Error: ${m.error||"Unknown error"}`,d==="pull"&&(await this.refresh(),await this.editor.forceReloadFile(this.editor.filePath))}catch(m){console.error(`${g} failed:`,m),n.textContent=`Error: ${m.message||"Check console for details."}`}finally{t.disabled=!1,s.disabled=!1}};t.addEventListener("click",()=>a("push")),s.addEventListener("click",()=>a("pull"));const r=this.contentContainer.querySelector("#git-commit-message");r&&!r.dataset.listenerAttached&&(r.dataset.listenerAttached="true",r.addEventListener("input",()=>this.updateCommitButtonState()));const c=this.contentContainer.querySelector(".git-view-container");c&&!c.dataset.listenerAttached&&(c.dataset.listenerAttached="true",c.addEventListener("click",async d=>{const h=d.target,u=h.closest(".git-file-item"),g=h.closest(".git-history-item");if(u){const m=u.dataset.filepath;h.matches(".git-file-path")?(this.editor.filePath!==m&&await this.editor.loadFile(m),this.editor.showDiff(await this.gitClient.readBlob(m))):h.matches(".git-action-button")&&(d.stopPropagation(),h.classList.contains("discard")?await this.showConfirm({title:"Discard Changes",message:`Are you sure you want to discard all changes to "${m}"? This cannot be undone.`,okText:"Discard",destructive:!0})&&(await this.gitClient.discard(m),this.editor.filePath===m&&await this.editor.forceReloadFile(m),await this.refresh()):h.classList.contains("stage")?(await this.gitClient.stage(m),await this.renderGitView()):h.classList.contains("unstage")&&(await this.gitClient.unstage(m),await this.renderGitView()))}else if(g&&h.closest(".git-history-header")){const m=g.querySelector(".git-history-details");if(m.style.display!=="none")m.style.display="none";else if(m.style.display="block",!m.dataset.loaded){m.innerHTML='<span class="no-changes">Loading...</span>';const v=g.dataset.oid,p=await this.gitClient.getChangedFiles(v),C=g.dataset.author,S=g.dataset.date,k=p.map(x=>{const M=typeof x=="string"?x:x.path;return`<div class="history-file-path" data-path="${M}">${M.substring(1)}</div>`}).join("");m.innerHTML=`
                    <div class="commit-meta">
                      <div><strong>Author:</strong> ${C}</div>
                      <div><strong>Date:</strong> ${S}</div>
                    </div>
                    <div class="history-file-list">${k||'<span class="no-changes">No files changed.</span>'}</div>
                  `,m.dataset.loaded="true"}}else if(h.closest(".history-file-path")){c.querySelectorAll(".history-file-path.active").forEach(C=>C.classList.remove("active")),h.classList.add("active");const m=h.closest(".git-history-item"),y=h.dataset.path,v=m.dataset.oid,p=m.dataset.parentOid;await this.editor.previewHistoricalFile(y,v,p)}}));const l=this.contentContainer.querySelector("#git-commit-button");l&&!l.dataset.listenerAttached&&(l.dataset.listenerAttached="true",l.addEventListener("click",async()=>{const d=this.contentContainer.querySelector("#git-commit-message"),h=d.value.trim();if(h)try{l.disabled=!0,l.textContent="Committing...",await this.gitClient.commit(h),this.editor.hideDiff(),d.value="",await this.refresh()}catch(u){console.error("Commit failed:",u),await this.showAlert({title:"Commit Failed",message:"The commit failed. Please see the console for more details."}),this.updateCommitButtonState(),l.textContent="Commit"}}))}};class He{constructor({target:e,gitClient:t,editor:s}){if(!t)throw new Error("Sidebar requires a gitClient instance.");if(!s)throw new Error("Sidebar requires an editor instance.");this.gitClient=t,this.editor=s,this.targetSelector=e;const n=document.querySelector(this.targetSelector);if(!n){console.error(`Sidebar container not found: ${this.targetSelector}`);return}this.container=n,this.tabsContainer=document.createElement("div"),this.tabsContainer.className="sidebar-tabs",this.contentContainer=document.createElement("div"),this.contentContainer.className="sidebar-content",this.container.appendChild(this.tabsContainer),this.container.appendChild(this.contentContainer),this.activeTab=sessionStorage.getItem("sidebarActiveTab")||"Files",Object.assign(this,Ue),Object.assign(this,qe),Object.assign(this,Ge)}async init(){this.renderTabs(),this.setupContextMenus(),await this.refresh()}async showAlert({title:e="Notice",message:t}){return new Promise(s=>{const n=new b({title:e});n.updateContent(`<p>${t}</p>`),n.addFooterButton("OK",()=>{n.destroy(),s()}),n.show()})}async showConfirm({title:e,message:t,okText:s="OK",destructive:n=!1}){return b.confirm({title:e,message:t,okText:s,destructive:n,cancelText:"Cancel"})}async ensureDir(e){const t=e.split("/").filter(n=>n);let s="";for(const n of t){s+=`/${n}`;try{await this.gitClient.pfs.stat(s)}catch(i){if(i.code==="ENOENT")try{await this.gitClient.pfs.mkdir(s)}catch(a){if(a.code!=="EEXIST")throw a}else throw i}}}setupContextMenus(){const e=[{type:"separator"},{label:"Command Palette",action:()=>window.thoughtform.commandPalette.open()}];new Y({targetSelector:".sidebar-content.files-view",itemSelector:"[data-filepath]",dataAttribute:"data-filepath",items:[{label:"New File",action:()=>this.handleNewFile()},{label:"Rename",action:t=>this.handleRename(t)},{label:"Duplicate",action:t=>this.handleDuplicate(t)},{label:"Delete",action:t=>this.handleDelete(t)},...e],containerItems:[{label:"New File",action:()=>this.handleNewFile()},...e]}),new Y({targetSelector:".sidebar-content.gardens-view",itemSelector:"[data-garden-name]",dataAttribute:"data-garden-name",items:[{label:"New Garden",action:()=>this.handleNewGarden()},{label:"Duplicate",action:t=>this.handleDuplicateGarden(t)},{label:"Delete",action:t=>this.handleDeleteGarden(t)},...e],containerItems:[{label:"New Garden",action:()=>this.handleNewGarden()},...e]})}renderTabs(){this.tabsContainer.innerHTML=`
      <button class="sidebar-tab" data-tab="Files">Files</button>
      <button class="sidebar-tab" data-tab="Gardens">Gardens</button>
      <button class="sidebar-tab" data-tab="Git">Git</button>
    `,this.tabsContainer.querySelectorAll(".sidebar-tab").forEach(e=>{e.addEventListener("click",t=>{const s=t.target.dataset.tab,n=this.activeTab;if(this.activeTab=s,sessionStorage.setItem("sidebarActiveTab",this.activeTab),n==="Git"&&s!=="Git"){const i=this.editor.getFilePath(window.location.hash);this.editor.loadFile(i)}this.refresh()})})}async refresh(){this.tabsContainer.querySelectorAll(".sidebar-tab").forEach(s=>{s.classList.toggle("active",s.dataset.tab===this.activeTab)}),this.contentContainer.className="sidebar-content",this.contentContainer.classList.add(`${this.activeTab.toLowerCase()}-view`);const e=await this.gitClient.getStatuses();this.activeTab==="Files"?await this.renderFiles(e):this.activeTab==="Gardens"?await this.renderGardens():this.activeTab==="Git"&&await this.renderGitView();const t=e.some(([,s,n])=>s!==n);this.tabsContainer.querySelector('[data-tab="Git"]').classList.toggle("dirty",t)}async listFiles(e,t){const s=e.pfs;let n=[];try{const i=await s.readdir(t);for(const a of i){if(a===".git")continue;const r=`${t==="/"?"":t}/${a}`;try{(await s.stat(r)).isDirectory()?n=n.concat(await this.listFiles(e,r)):n.push(r)}catch{console.warn(`Could not stat ${r}, skipping.`)}}}catch{console.log(`Directory not found: ${t}. No files to list.`)}return n}}const We=be.define(),je=N.theme({"&":{color:"var(--color-text-primary)",backgroundColor:"var(--color-background-primary)"},".cm-content":{caretColor:"var(--color-text-bright)"},"&.cm-focused .cm-cursor":{borderLeftColor:"var(--color-text-bright)"},"&.cm-focused .cm-selectionBackground, .cm-selectionBackground, .cm-content ::selection":{backgroundColor:"var(--color-background-hover)"},".cm-gutters":{backgroundColor:"var(--color-background-primary)",color:"var(--color-text-secondary)",border:"none"},".cm-embed-container":{display:"block",padding:"10px 0"},".cm-embedded-image":{maxWidth:"100%",maxHeight:"500px",display:"block",margin:"0 auto",borderRadius:"4px",border:"1px solid var(--color-border)"},".cm-embed-placeholder, .cm-embed-error":{display:"block",padding:"10px",backgroundColor:"var(--color-background-secondary)",borderRadius:"4px",fontStyle:"italic",color:"var(--color-text-secondary)"},".cm-embed-error":{color:"var(--color-text-destructive)"}},{dark:!0}),ze=ve.define([{tag:f.keyword,color:"var(--base-accent-emphasis)",class:"cm-keyword"},{tag:[f.name,f.deleted,f.character,f.propertyName,f.macroName],color:"var(--base-accent-info)",class:"cm-name"},{tag:[f.processingInstruction,f.string,f.inserted],color:"var(--base-accent-emphasis)",class:"cm-string"},{tag:[f.function(f.variableName),f.labelName],color:"var(--base-accent-action)",class:"cm-function"},{tag:[f.color,f.constant(f.name),f.standard(f.name)],color:"var(--base-accent-action)",class:"cm-constant"},{tag:[f.definition(f.name),f.separator],color:"var(--base-text-primary)",class:"cm-definition"},{tag:[f.typeName,f.className,f.number,f.changed,f.annotation,f.modifier,f.self,f.namespace],color:"var(--base-accent-action)",class:"cm-type"},{tag:[f.operator,f.operatorKeyword,f.url,f.escape,f.regexp,f.link,f.special(f.string)],color:"var(--base-text-primary)",class:"cm-operator"},{tag:[f.meta,f.comment],color:"var(--base-text-muted)",class:"cm-comment"},{tag:We,color:"var(--base-accent-highlight)",fontStyle:"italic",class:"cm-hashtag"},{tag:f.strong,fontWeight:"bold",class:"cm-strong"},{tag:f.emphasis,fontStyle:"italic",class:"cm-emphasis"},{tag:f.strikethrough,textDecoration:"line-through",class:"cm-strikethrough"},{tag:f.link,color:"var(--base-syntax-wikilink-bg)",textDecoration:"underline",class:"cm-link"},{tag:f.heading,fontWeight:"bold",color:"var(--base-accent-info)",class:"cm-heading"},{tag:[f.atom,f.bool,f.special(f.variableName)],color:"var(--base-accent-action)",class:"cm-atom"},{tag:f.invalid,color:"var(--base-accent-destructive)",class:"cm-invalid"}]),Ve=[je,Se(ze)];function Ke(o,e){const t=document.createElement("div");t.id="drag-overlay",t.innerHTML="<p>Drop files or folders to add them to the garden</p>",document.body.appendChild(t);const s=a=>{t.innerHTML=`<p>${a}</p>`,t.classList.add("visible")},n=()=>{t.classList.remove("visible")},i=async(a,r)=>{let c=a;if(a.some(p=>p.isDirectory&&p.name===".git")){const p=await b.choice({title:".git Directory Detected",message:"<p>The content you dropped contains a .git repository. This could unintentionally overwrite your garden's history.</p><p>How would you like to proceed?</p>",choices:[{id:"import_safe",text:"Import Files (Ignore .git folder)"},{id:"cancel",text:"Cancel Import",class:"destructive"}]});if(!p||p==="cancel"){r("Import cancelled by user.","Import cancelled by user.");return}c=a.filter(C=>!(C.isDirectory&&C.name===".git")),r("Ignoring .git directory and proceeding with import.","Ignoring .git directory.")}const d=[],h=[],u=["png","jpg","jpeg","gif","svg","webp","avif"],g=async(p,C)=>{if(p.isFile){const S=await new Promise(x=>p.file(x)),k=`${C}/${S.name}`;S.name.toLowerCase().endsWith(".zip")?h.push(S):d.push({file:S,path:k})}else if(p.isDirectory){const S=p.createReader(),k=await new Promise(x=>S.readEntries(x));for(const x of k)await g(x,`${C}/${p.name}`)}};r("Scanning dropped items...","Scanning dropped items...");for(const p of c)await g(p,"");const m=`Found ${d.length} file(s) and ${h.length} zip archive(s) to process.`;r(m,m);const y=d.map(async({file:p,path:C})=>{let S;const k=p.name.split(".").pop()?.toLowerCase();return u.includes(k)?S=await p.arrayBuffer():S=await p.text(),o.writeFile(C,S)});if((await Promise.allSettled(y)).forEach((p,C)=>{const S=d[C].path;if(p.status==="rejected"){const k=`<span style="color: var(--color-text-destructive);">ERROR:</span> Failed to write "${S}": ${p.reason}`,x=`ERROR: Failed to write "${S}": ${p.reason}`;r(k,x)}else{const k=`<span style="color: var(--color-text-success);">OK:</span> Imported "${S}"`,x=`OK: Imported "${S}"`;r(k,x)}}),h.length>0){const p="Note: Zip archives must be imported via the DevTools > Data panel.";r(p,p)}};window.addEventListener("dragenter",a=>{a.preventDefault(),a.dataTransfer.types.includes("Files")&&s("Drop files or folders to add them to the garden")}),window.addEventListener("dragover",a=>{a.preventDefault()}),window.addEventListener("dragleave",a=>{a.clientX===0&&a.clientY===0&&n()}),window.addEventListener("drop",async a=>{a.preventDefault(),n();const r=a.dataTransfer.items;if(!r||r.length===0)return;const c=Array.from(r).map(l=>l.webkitGetAsEntry()).filter(Boolean);if(c.length>0){const l=new b({title:"Importing Files..."}),d=document.createElement("div");d.style.fontFamily="monospace",d.style.maxHeight="300px",d.style.overflowY="auto",d.style.fontSize="12px",l.updateContent(""),l.content.appendChild(d),l.show();let h="";const u=(g,m)=>{console.log(`[Import Log] ${m}`),h+=`<div>${g}</div>`,d.innerHTML=h,d.scrollTop=d.scrollHeight};try{await i(c,u),u("<strong>Import process complete.</strong>","Import process complete.")}catch(g){const m=`<strong style="color: var(--color-text-destructive);">A critical error occurred: ${g.message}</strong>`,y=`A critical error occurred: ${g.message}`;u(m,y),console.error("[DragDrop] A critical error occurred during import:",g)}finally{l.addFooterButton("Close",()=>l.destroy()),await e.refresh()}}})}const Je=L.mark({class:"cm-hashtag"}),Ye=$.fromClass(class{decorations;constructor(o){this.decorations=this.findHashtags(o)}update(o){(o.docChanged||o.viewportChanged)&&(this.decorations=this.findHashtags(o.view))}findHashtags(o){const e=new T,t=/#[\w-]+/g;for(const{from:s,to:n}of o.visibleRanges){const i=o.state.doc.sliceString(s,n);let a;for(;a=t.exec(i);){const r=s+a.index,c=r+a[0].length,l=o.state.doc.lineAt(r);if(r>l.from){const g=o.state.doc.sliceString(r-1,r);if(/\s/.test(g)===!1)continue}const d=/https?:\/\/[^\s]+/g;let h,u=!1;for(;h=d.exec(l.text);){const g=l.from+h.index,m=g+h[0].length;if(r>=g&&c<=m){u=!0;break}}u||e.add(r,c,Je)}}return e.finish()}},{decorations:o=>o.decorations}),R=ae.define({create:()=>({gitClient:null,sidebar:null}),update:(o,e)=>o});async function Xe(o,e){if(!e.sidebar||!e.gitClient)return null;const t=await e.sidebar.listFiles(e.gitClient,"/"),s=o.toLowerCase();for(const n of t)if((n.startsWith("/")?n.substring(1):n).toLowerCase()===s)return n;return null}async function he(o,e){if(!o)return;let t=o.split("|")[0].trim(),s=null;if(t.includes("#")&&([s,t]=t.split("#")),s){t.startsWith("/")||(t=`/${t}`);const n=new URL(import.meta.url).pathname,i=n.lastIndexOf("/src/"),a=i>-1?n.substring(0,i):"";window.location.href=`${window.location.origin}${a}/${encodeURIComponent(s)}#${encodeURIComponent(t)}`}else{const n=await Xe(t,e);let i;n?i=n:i=t.startsWith("/")?t:`/${t}`,window.location.hash=`#${encodeURIComponent(i)}`}}const Ze=K.of([{key:"Mod-Enter",run:o=>{const e=o.state.field(R);if(!e.gitClient)return!1;const t=o.state.selection.main.head,s=o.state.doc.lineAt(t),n=[{type:"wikilink",regex:/\[\[([^\[\]]+?)\]\]/g},{type:"markdown",regex:/\[[^\]]*\]\(([^)]+)\)/g},{type:"naked",regex:/(https?:\/\/[^\s]+)|(www\.[^\s]+)/g}];for(const{type:i,regex:a}of n){let r;for(;r=a.exec(s.text);){const c=s.from+r.index,l=c+r[0].length;if(t>=c&&t<=l){if(i==="wikilink")he(r[1],e);else{let d=i==="markdown"?r[1]:r[0];d.startsWith("www.")&&(d=`https://${d}`),window.open(d,"_blank","noopener,noreferrer")}return!0}}}return!1}}]),Qe=L.mark({class:"cm-wikilink"});class et{constructor(e){this.view=e,this.decorations=this.findWikilinks(e),this.longPressTimeout=null,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.view.dom.addEventListener("mousedown",this.onMouseDown),this.view.dom.addEventListener("mouseup",this.onMouseUp),this.view.dom.addEventListener("touchstart",this.onTouchStart,{passive:!1}),this.view.dom.addEventListener("touchend",this.onTouchEnd),this.view.dom.addEventListener("touchmove",this.onTouchMove,{passive:!0})}destroy(){this.clearLongPressTimeout(),this.view.dom.removeEventListener("mousedown",this.onMouseDown),this.view.dom.removeEventListener("mouseup",this.onMouseUp),this.view.dom.removeEventListener("touchstart",this.onTouchStart),this.view.dom.removeEventListener("touchend",this.onTouchEnd),this.view.dom.removeEventListener("touchmove",this.onTouchMove)}handleNavigation(e){const t=this.view.state.field(R);t.gitClient&&he(e.textContent.slice(2,-2),t)}onMouseDown(e){const t=e.target.closest(".cm-wikilink");t&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.handleNavigation(t))}onMouseUp(){this.clearLongPressTimeout()}onTouchStart(e){const t=e.target.closest(".cm-wikilink");t&&(e.preventDefault(),this.longPressTimeout=setTimeout(()=>{this.handleNavigation(t),this.longPressTimeout=null},500))}onTouchEnd(){this.clearLongPressTimeout()}onTouchMove(){this.clearLongPressTimeout()}clearLongPressTimeout(){this.longPressTimeout&&(clearTimeout(this.longPressTimeout),this.longPressTimeout=null)}update(e){(e.docChanged||e.viewportChanged)&&(this.decorations=this.findWikilinks(e.view))}findWikilinks(e){const t=new T,s=/\[\[([^\[\]]+?)\]\]/g;for(const{from:n,to:i}of e.visibleRanges){const a=e.state.doc.sliceString(n,i);let r;for(;r=s.exec(a);){const c=n+r.index,l=c+r[0].length;t.add(c,l,Qe)}}return t.finish()}}const tt=$.fromClass(et,{decorations:o=>o.decorations}),st=L.mark({class:"cm-checkbox-todo"}),nt=L.mark({class:"cm-checkbox-done"}),it=L.mark({class:"cm-checkbox-doing"}),ot=$.fromClass(class{decorations;constructor(o){this.decorations=this.findCheckboxes(o)}update(o){(o.docChanged||o.viewportChanged)&&(this.decorations=this.findCheckboxes(o.view))}findCheckboxes(o){const e=new T,t=/^\s*(\[([ |x|-])\])/gm;for(const{from:s,to:n}of o.visibleRanges){const i=o.state.doc.sliceString(s,n);let a;for(;a=t.exec(i);){const r=a[2],c=s+a.index+a[0].indexOf("["),l=c+3;r===" "?e.add(c,l,st):r==="x"?e.add(c,l,nt):r==="-"&&e.add(c,l,it)}}return e.finish()}},{decorations:o=>o.decorations}),at=L.mark({class:"cm-timestamp"}),rt=$.fromClass(class{decorations;constructor(o){this.decorations=this.findTimestamps(o)}update(o){(o.docChanged||o.viewportChanged)&&(this.decorations=this.findTimestamps(o.view))}findTimestamps(o){const e=new T,t=/^\s*(?:>\s*)*(\d{4,})\s/gm;for(const{from:s,to:n}of o.visibleRanges){const i=o.state.doc.sliceString(s,n);let a;for(;a=t.exec(i);){const r=a[0],c=a[1],l=s+a.index+r.indexOf(c),d=l+c.length;e.add(l,d,at)}}return e.finish()}},{decorations:o=>o.decorations}),ct=L.mark({class:"cm-naked-link"});function lt(o){return o?o.startsWith("www.")?"https://"+o:o:null}class dt{constructor(e){this.view=e,this.decorations=this.findNakedLinks(e),this.longPressTimeout=null,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.view.dom.addEventListener("mousedown",this.onMouseDown),this.view.dom.addEventListener("mouseup",this.onMouseUp),this.view.dom.addEventListener("touchstart",this.onTouchStart,{passive:!1}),this.view.dom.addEventListener("touchend",this.onTouchEnd),this.view.dom.addEventListener("touchmove",this.onTouchMove,{passive:!0})}destroy(){this.clearLongPressTimeout(),this.view.dom.removeEventListener("mousedown",this.onMouseDown),this.view.dom.removeEventListener("mouseup",this.onMouseUp),this.view.dom.removeEventListener("touchstart",this.onTouchStart),this.view.dom.removeEventListener("touchend",this.onTouchEnd),this.view.dom.removeEventListener("touchmove",this.onTouchMove)}handleNavigation(e){const t=e.target.closest(".cm-naked-link, .cm-url");if(!t)return!1;const s=lt(t.textContent);return s&&window.open(s,"_blank","noopener,noreferrer"),!0}onMouseDown(e){(e.ctrlKey||e.metaKey)&&this.handleNavigation(e)&&e.preventDefault()}onMouseUp(){this.clearLongPressTimeout()}onTouchStart(e){e.target.closest(".cm-naked-link, .cm-url")&&(e.preventDefault(),this.longPressTimeout=setTimeout(()=>{this.handleNavigation(e),this.longPressTimeout=null},500))}onTouchEnd(){this.clearLongPressTimeout()}onTouchMove(){this.clearLongPressTimeout()}clearLongPressTimeout(){this.longPressTimeout&&(clearTimeout(this.longPressTimeout),this.longPressTimeout=null)}update(e){(e.docChanged||e.viewportChanged)&&(this.decorations=this.findNakedLinks(e.view))}findNakedLinks(e){const t=new T,s=/(https?:\/\/[^\s]+)|(www\.[^\s]+)/g;for(const{from:n,to:i}of e.visibleRanges){const a=e.state.doc.sliceString(n,i);let r;for(;r=s.exec(a);){const c=e.state.doc.lineAt(n+r.index);if(/\[.*\]\(.*\)/.test(c.text)&&c.text.includes(`](${r[0]})`))continue;const l=n+r.index,d=l+r[0].length;t.add(l,d,ct)}}return t.finish()}}const ht=$.fromClass(dt,{decorations:o=>o.decorations}),ut=L.line({class:"cm-blockquote"}),gt=$.fromClass(class{decorations;constructor(o){this.decorations=this.findBlockquotes(o)}update(o){(o.docChanged||o.viewportChanged)&&(this.decorations=this.findBlockquotes(o.view))}findBlockquotes(o){const e=new T,t=/^\s*>\s/;for(const{from:s,to:n}of o.visibleRanges){let i=s;for(;i<=n;){const a=o.state.doc.lineAt(i);t.test(a.text)&&e.add(a.from,a.from,ut),i=a.to+1}}return e.finish()}},{decorations:o=>o.decorations}),mt=L.line({class:"cm-hr"}),ft=$.fromClass(class{decorations;constructor(o){this.decorations=this.findRulers(o)}update(o){(o.docChanged||o.viewportChanged)&&(this.decorations=this.findRulers(o.view))}findRulers(o){const e=new T,t=/^\s*([-=*_]){3,}\s*$/;for(const{from:s,to:n}of o.visibleRanges){let i=s;for(;i<=n;){const a=o.state.doc.lineAt(i);t.test(a.text)&&e.add(a.from,a.from,mt),i=a.to+1}}return e.finish()}},{decorations:o=>o.decorations}),ue=["png","jpg","jpeg","gif","svg","webp","avif"];function pt(o){switch(o.toLowerCase()){case"png":return"image/png";case"jpg":case"jpeg":return"image/jpeg";case"gif":return"image/gif";case"svg":return"image/svg+xml";case"webp":return"image/webp";case"avif":return"image/avif";default:return"application/octet-stream"}}class X extends Ee{constructor(e,t,s,n){super(),this.linkTarget=e,this.altText=t,this.type=s,this.view=n,this.objectURL=null}eq(e){return this.linkTarget===e.linkTarget&&this.type===e.type}toDOM(){const e=document.createElement("span");if(e.className="cm-embed-container",this.type==="external"){const t=document.createElement("img");t.src=this.linkTarget,t.alt=this.altText,t.className="cm-embedded-image",e.appendChild(t)}else{const t=document.createElement("span");t.className="cm-embed-placeholder",t.textContent=`Loading: ${this.linkTarget}`,e.appendChild(t),this.loadInternalContent(e).catch(s=>{console.error(`Failed to load internal embed for ${this.linkTarget}:`,s),t.textContent=`Error: ${this.linkTarget} not found.`,e.classList.add("cm-embed-error")})}return e}async loadInternalContent(e){let s=decodeURIComponent(this.linkTarget),n=null;s.includes("#")&&([n,s]=s.split("#"));const i=s.split(".").pop()?.toLowerCase();if(!ue.includes(i)){e.textContent="",e.style.display="none";return}const a=this.view.state.field(R);let r;n&&n!==a.gitClient.gardenName?r=new P(n):r=a.gitClient;const c=s.startsWith("/")?s:`/${s}`,l=await r.readFileAsBuffer(c);if(!l)throw new Error("File could not be read as a buffer.");const d=pt(i),h=new Blob([l],{type:d});this.objectURL=URL.createObjectURL(h);const u=document.createElement("img");u.src=this.objectURL,u.alt=this.linkTarget,u.className="cm-embedded-image",e.innerHTML="",e.appendChild(u)}destroy(){this.objectURL&&URL.revokeObjectURL(this.objectURL)}}function Z(o){const e=new T,t=W(o.state),s=n=>{let i=t.resolve(n,1);for(;i;){if(i.name.includes("Code"))return!0;i=i.parent}return!1};for(const{from:n,to:i}of o.visibleRanges){const a=o.state.doc.sliceString(n,i),r=/!\[\[([^\[\]]+?)\]\]/g;let c;for(;c=r.exec(a);){const d=n+c.index;if(s(d))continue;const h=d+c[0].length,u=c[1];e.add(d,h,L.replace({widget:new X(u,u,"internal",o)}))}const l=/!\[(.*?)\]\((.*?)\)/g;for(;c=l.exec(a);){const d=n+c.index;if(s(d))continue;const h=d+c[0].length,u=c[1],g=c[2],m=g.split(".").pop()?.toLowerCase()?.split("?")[0];g.startsWith("http")&&ue.includes(m)&&e.add(d,h,L.replace({widget:new X(g,u,"external",o)}))}}return e.finish()}const yt=$.fromClass(class{constructor(o){this.decorations=Z(o)}update(o){(o.docChanged||o.viewportChanged||W(o.startState)!==W(o.state))&&(this.decorations=Z(o.view))}},{decorations:o=>o.decorations}),wt=[Ye,tt,ot,rt,ht,gt,ft,yt],Q=ke.define(xe),bt=Le({base:Me,codeLanguages:[O.of({name:"javascript",load:()=>Promise.resolve(re())}),O.of({name:"html",load:()=>Promise.resolve(ce())}),O.of({name:"css",load:()=>Promise.resolve(le())})]});function ee(o){const e=o.split("/").pop(),t=e.includes(".")?e.split(".").pop().toLowerCase():"";switch(e){case".gitignore":case".npmrc":case".editorconfig":case"Dockerfile":return Q}switch(t){case"js":return re();case"css":return le();case"html":return ce();case"json":return Te();case"xml":return $e();case"yaml":case"yml":return Pe();case"sh":case"bash":case"zsh":return Q;default:return bt}}const Ct=L.mark({class:"cm-diff-inserted"});function te(o,e){const t=[],s=e.doc.toString(),n=_(o,s);let i=0;for(const[a,r]of n)a===_.INSERT&&t.push(Ct.range(i,i+r.length)),a!==_.DELETE&&(i+=r.length);return L.set(t)}const U=new j;function vt(o){return ae.define({create(e){return te(o,e)},update(e,t){return t.docChanged?te(o,t.state):e.map(t.changes)},provide:e=>N.decorations.from(e)})}const St=$.fromClass(class{constructor(o){this.view=o,this.statusBar=document.createElement("div"),this.statusBar.className="token-status-bar",this.countElement=document.createElement("span"),this.countElement.className="token-count",this.statusBar.appendChild(this.countElement);const e=o.dom.closest("main");e?e.appendChild(this.statusBar):o.dom.parentNode.insertBefore(this.statusBar,o.dom.nextSibling),this.debouncedUpdate=oe(this.updateTokenCount.bind(this),250),this.updateTokenCount()}update(o){o.docChanged&&this.debouncedUpdate()}updateTokenCount(){try{const o=this.view.state.doc.toString(),e=Oe(o);this.countElement.textContent=`Tokens: ${e.toLocaleString()}`}catch(o){console.warn("Token counting error:",o),this.countElement.textContent="Tokens: Error"}}destroy(){this.debouncedUpdate.cancel(),this.statusBar&&this.statusBar.remove()}});function Et(){return St}const kt=K.of([{key:"Mod-Enter",run:o=>{const e=o.state.selection.main.head;return o.state.doc.lineAt(e).text.trim().startsWith(">")?(window.thoughtform.ai.handleAiChatRequest(o),!0):!1}}]),q=Fe.define();class A{static editors=[];constructor({url:e,target:t="body main",editorConfig:s={},gitClient:n,commandPalette:i}){if(!n)throw new Error("Editor requires a gitClient instance.");if(!i)throw new Error("Editor requires a commandPalette instance.");window.location.hash||(window.location.hash="#home"),this.targetSelector=t,this.url=e||window.location.hash,this.editorConfig=s,this.gitClient=n,this.commandPalette=i,this.editorView=null,this.sidebar=null,this.filePath=this.getFilePath(this.url),this.isReady=!1,this.mainContainer=null,this.languageCompartment=new j,this.tokenCounterCompartment=new j,this.imageViewerElement=null,this.currentObjectUrl=null,this.debouncedHandleUpdate=oe(this.handleUpdate.bind(this),500),this.init()}async init(){if(this.mainContainer=document.querySelector(this.targetSelector),!this.mainContainer){console.error(`Target container not found: ${this.targetSelector}`);return}await this.gitClient.initRepo(),this.sidebar=new He({target:"#sidebar",gitClient:this.gitClient,editor:this}),await this.sidebar.init(),Ke(this.gitClient,this.sidebar);const e=await this.loadFileContent(this.filePath),t=document.getElementById("loading-indicator");t&&t.remove(),this.mainContainer.style.display="flex",this.imageViewerElement=document.createElement("div"),this.imageViewerElement.className="image-viewer-container",this.mainContainer.appendChild(this.imageViewerElement);const s=N.updateListener.of(n=>{n.docChanged&&!n.transactions.some(i=>i.annotation(q))&&this.debouncedHandleUpdate(n.state.doc.toString())});Ie.map("jj","<Esc>","insert"),this.editorView=new N({doc:e,extensions:[R.init(()=>({gitClient:this.gitClient,sidebar:this.sidebar})),De(),Ne,N.lineWrapping,Re,Ve,this.languageCompartment.of(ee(this.filePath)),s,...wt,U.of([]),this.tokenCounterCompartment.of(Et()),...this.editorConfig.extensions||[],kt,Ze,K.of([Ae])],parent:this.mainContainer}),A.editors.push(this),this.isReady=!0,this.listenForNavigation(),this.loadFile(this.filePath),this.editorView.focus()}async loadFileContent(e){try{return await this.gitClient.readFile(e)}catch(t){return console.warn(`Could not read file ${e}, starting with empty content.`,t),""}}async showDiff(e){if(e===null){console.error("Cannot show diff, original content is null."),this.hideDiff();return}const t=vt(e);this.editorView.dispatch({effects:U.reconfigure(t)})}hideDiff(){this.editorView.dispatch({effects:U.reconfigure([])})}listenForNavigation(){window.addEventListener("hashchange",async()=>{this.hideDiff();const e=this.getFilePath(window.location.hash);e&&this.filePath!==e&&await this.loadFile(e)})}async previewHistoricalFile(e,t,s){const[n,i]=await Promise.all([this.gitClient.readBlobFromCommit(t,e),this.gitClient.readBlobFromCommit(s,e)]);if(n===null||i===null){await this.sidebar.showAlert({title:"Error",message:"Could not load historical diff for this file."});return}this.editorView.dispatch({changes:{from:0,to:this.editorView.state.doc.length,insert:n},annotations:q.of(!0)}),this.showDiff(i)}async loadFile(e){const t=["png","jpg","jpeg","gif","svg","webp","avif"],s=e.split(".").pop()?.toLowerCase();if(t.includes(s)){this.hideDiff(),this.mainContainer.classList.remove("is-editor"),this.mainContainer.classList.add("is-image-preview"),this.imageViewerElement.innerHTML="<p>Loading image...</p>";const r=await this.gitClient.readFileAsBuffer(e);if(r){const c=`image/${s==="svg"?"svg+xml":s}`,l=new Blob([r],{type:c});this.currentObjectUrl&&URL.revokeObjectURL(this.currentObjectUrl),this.currentObjectUrl=URL.createObjectURL(l),this.imageViewerElement.innerHTML=`<img src="${this.currentObjectUrl}" alt="${e}" />`}else this.imageViewerElement.innerHTML=`<p class="error">Could not load image: ${e}</p>`;this.filePath=e,this.sidebar&&await this.sidebar.refresh();return}this.mainContainer.classList.remove("is-image-preview"),this.mainContainer.classList.add("is-editor"),this.currentObjectUrl&&(URL.revokeObjectURL(this.currentObjectUrl),this.currentObjectUrl=null),this.hideDiff();const n=await this.loadFileContent(e);this.filePath=e;const i=ee(e);this.editorView.dispatch({effects:this.languageCompartment.reconfigure(i)});const a=this.editorView.state.doc;this.editorView.dispatch({changes:{from:0,to:a.length,insert:n},annotations:q.of(!0)}),this.sidebar&&await this.sidebar.refresh(),this.editorView.focus()}async forceReloadFile(e){await this.loadFile(e)}async handleUpdate(e){this.isReady&&this.filePath===this.getFilePath(window.location.hash)&&(await this.gitClient.writeFile(this.filePath,e),this.sidebar&&await this.sidebar.refresh())}getFilePath(e){let t=e.startsWith("#")?e.substring(1):e;return t=decodeURIComponent(t),t||(t="home"),t}}window.Editor=A;function xt(){Lt(),Pt()}function Lt(){const o=document.querySelector(".app-container"),e=document.getElementById("resizer"),t=document.getElementById("resize-overlay");if(!o||!e||!t)return;const s=document.createElement("button");s.id="sidebar-toggle-icon",s.title="Toggle Sidebar (Ctrl + [)",e.appendChild(s);let n=0,i=!1;const a=()=>{if(o.classList.contains("sidebar-collapsed")){const g=localStorage.getItem("sidebarWidth")||"250px";o.classList.remove("sidebar-collapsed"),document.documentElement.style.setProperty("--sidebar-width",g),localStorage.setItem("sidebarCollapsed","false"),s.textContent="‹"}else{const g=document.documentElement.style.getPropertyValue("--sidebar-width");g!=="0px"&&localStorage.setItem("sidebarWidth",g),o.classList.add("sidebar-collapsed"),document.documentElement.style.setProperty("--sidebar-width","0px"),localStorage.setItem("sidebarCollapsed","true"),s.textContent="›"}};window.thoughtform&&window.thoughtform.ui&&(window.thoughtform.ui.toggleSidebar=a);const r=u=>{u.type==="touchmove"&&u.preventDefault();const g=u.clientX||u.touches&&u.touches[0].clientX;if(Math.abs(g-n)>5&&(i=!0),i){const m=Math.max(24,Math.min(g,window.innerWidth-100));document.documentElement.style.setProperty("--sidebar-width",`${m}px`),o.classList.remove("sidebar-collapsed"),s.textContent="‹"}},c=()=>{if(t.style.display="none",document.body.style.cursor="default",document.body.style.userSelect="auto",document.removeEventListener("mousemove",r),document.removeEventListener("touchmove",r),document.removeEventListener("mouseup",c),document.removeEventListener("touchend",c),i){const u=document.documentElement.style.getPropertyValue("--sidebar-width");localStorage.setItem("sidebarWidth",u),localStorage.setItem("sidebarCollapsed","false")}else a()},l=u=>{n=u.clientX||u.touches&&u.touches[0].clientX,i=!1,u.preventDefault(),t.style.display="block",document.body.style.cursor="col-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",r,{passive:!1}),document.addEventListener("touchmove",r,{passive:!1}),document.addEventListener("mouseup",c),document.addEventListener("touchend",c)};e.addEventListener("mousedown",l),e.addEventListener("touchstart",l,{passive:!1});const d=localStorage.getItem("sidebarWidth");localStorage.getItem("sidebarCollapsed")==="true"?(o.classList.add("sidebar-collapsed"),document.documentElement.style.setProperty("--sidebar-width","0px"),s.textContent="›"):(document.documentElement.style.setProperty("--sidebar-width",d||"250px"),s.textContent="‹")}function Pt(){const o=document.getElementById("eruda-container"),e=document.getElementById("eruda-resizer");let t;if(!o||!e)return;const s=document.createElement("button");s.id="eruda-toggle",s.title="Toggle DevTools (Ctrl + `)",e.appendChild(s);let n=0,i=!1;const a=(h=null,u=null)=>{if(t=document.querySelector(".eruda-dev-tools"),!t)return;const g=t.style.height==="0px"||t.offsetHeight<10;if(h===null?g:h){const y=localStorage.getItem("erudaHeight")||"250px";t.style.height=y,s.textContent="▼",localStorage.setItem("erudaCollapsed","false"),u&&setTimeout(()=>window.thoughtform.eruda?.show(u),50)}else{if(g)return;localStorage.setItem("erudaHeight",t.style.height),t.style.height="0px",s.textContent="▲",localStorage.setItem("erudaCollapsed","true")}};window.thoughtform&&window.thoughtform.ui&&(window.thoughtform.ui.toggleDevtools=a);const r=h=>{h.type==="touchmove"&&h.preventDefault();const u=h.clientY||h.touches&&h.touches[0].clientY;if(Math.abs(u-n)>5&&(i=!0),!i)return;const g=window.innerHeight-u,m=42,y=window.innerHeight-100;t.style.height=`${Math.max(m,Math.min(g,y))}px`,s.textContent="▼"},c=()=>{document.body.style.cursor="default",document.body.style.userSelect="auto",document.removeEventListener("mousemove",r),document.removeEventListener("touchmove",r),document.removeEventListener("mouseup",c),document.removeEventListener("touchend",c),i?(localStorage.setItem("erudaHeight",t.style.height),localStorage.setItem("erudaCollapsed","false")):a(null,null)},l=h=>{n=h.clientY||h.touches&&h.touches[0].clientY,i=!1,h.preventDefault(),t=document.querySelector(".eruda-dev-tools"),t&&(document.body.style.cursor="row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",r),document.addEventListener("touchmove",r,{passive:!1}),document.addEventListener("mouseup",c),document.addEventListener("touchend",c))};e.addEventListener("mousedown",l),e.addEventListener("touchstart",l,{passive:!1});const d=new MutationObserver(()=>{t=document.querySelector(".eruda-dev-tools"),t&&(localStorage.getItem("erudaCollapsed")==="true"?(t.style.height="0px",s.textContent="▲"):(t.style.height=localStorage.getItem("erudaHeight")||"150px",s.textContent="▼"),d.disconnect())});d.observe(o,{childList:!0})}async function ge(o,e){const t=o.pfs;let s=[];try{const n=await t.readdir(e);for(const i of n){const a=`${e==="/"?"":e}/${i}`;try{(await t.stat(a)).isDirectory()?s=s.concat(await ge(o,a)):s.push(a)}catch{console.warn(`Could not stat ${a}, skipping.`)}}}catch{console.log(`Could not read directory: ${e}.`)}return s}async function me(o,e){try{if((await o.stat(e)).isDirectory()){const s=await o.readdir(e);for(const n of s)await me(o,`${e}/${n}`);await o.rmdir(e)}else await o.unlink(e)}catch(t){if(t.code!=="ENOENT")throw console.error(`Error during rmrf for ${e}:`,t),t}}async function $t(o,e){e("Starting export...");const t=new V;if(!o||o.length===0)throw new Error("No gardens were selected for export.");for(const r of o){e(`Processing garden: "${r}"...`);const c=t.folder(r),l=new P(r),d=await ge(l,"/");for(const h of d){const u=await l.pfs.readFile(h),g=h.startsWith("/")?h.substring(1):h;c.file(g,u)}}e("Generating zip file...");const s=await t.generateAsync({type:"blob"}),i=`thoughtform-gardens-backup-${new Date().toISOString().replace(/[:.]/g,"-")}.zip`,a=document.createElement("a");a.href=URL.createObjectURL(s),a.download=i,document.body.appendChild(a),a.click(),document.body.removeChild(a),e(`Export process initiated: ${i}`)}async function Tt(o){const e=await V.loadAsync(o),t=new Set;return e.forEach(s=>{if(s.includes("/")){const n=s.split("/")[0];t.add(n)}}),Array.from(t).sort()}async function Mt(o,e,t){if(!e||e.length===0)throw new Error("No gardens were selected for import.");t(`Reading ${o.name}...`);const s=await V.loadAsync(o);t("Zip file loaded. Analyzing backup contents...");let n="merge";const i=[];for(const d of e){const h=new P(d);let u=!1;try{await h.pfs.stat("/.git"),u=!0}catch{}const g=Object.keys(s.files).some(m=>m.startsWith(`${d}/.git/`));u&&g&&i.push(d)}if(i.length>0){const d=`<ul>${i.map(u=>`<li><strong>${u}</strong></li>`).join("")}</ul>`,h=await b.choice({title:"Replace Garden History?",message:`<p>The backup contains a git history for the following existing garden(s):</p>
                ${d}
                <p>Replacing history is a destructive action. How should we proceed?</p>`,choices:[{id:"replace",text:"Replace History",class:"destructive"},{id:"merge",text:"Merge Files, Keep Local History"},{id:"cancel",text:"Cancel Import"}]});if(!h||h==="cancel"){t("Import cancelled by user.");return}n=h}if(n==="replace"){t("Strategy: Replacing history for conflicting gardens.");for(const d of i){t(`  Deleting existing .git directory for "${d}"...`);const h=new P(d);await me(h.pfs,"/.git"),t(`  Done deleting for "${d}".`)}}else t("Strategy: Merging files and keeping local history where conflicts exist.");const a=new Map;t("Initializing target gardens...");for(const d of e){const h=new P(d);await h.initRepo(),a.set(d,h)}t("Initialization complete. Starting file writes...");const r=[];s.forEach((d,h)=>{if(h.dir)return;const u=d.split("/")[0];if(!e.includes(u)||d.substring(u.length+1).startsWith(".git/")&&n==="merge"&&i.includes(u))return;const m=`/${d.substring(u.length+1)}`,y=h.async("uint8array").then(async v=>{await a.get(u).writeFile(m,v)});r.push(y)});const c=r.length;let l=0;r.forEach(d=>d.then(()=>{l++,(l%100===0||l===c)&&t(`Writing files... (${l}/${c})`)})),await Promise.all(r),t("Import complete! Reloading page..."),setTimeout(()=>window.location.reload(),1500)}async function Ft(o,e){if(!o||o.length===0)throw new Error("No gardens were selected for deletion.");e("Starting deletion process...");const t=localStorage.getItem("thoughtform_gardens");let s=t?JSON.parse(t):[];for(const n of o){e(`Deleting garden: "${n}"...`),s=s.filter(a=>a!==n);const i=`garden-fs-${n}`;await new Promise((a,r)=>{const c=indexedDB.deleteDatabase(i);c.onsuccess=()=>{e(`  Successfully deleted database: ${i}`),a()},c.onerror=l=>{e(`  Error deleting database: ${i}`),r(l.target.error)},c.onblocked=()=>{e(`  Deletion blocked for ${i}. Please refresh and try again.`),r(new Error("Deletion blocked"))}})}localStorage.setItem("thoughtform_gardens",JSON.stringify(s)),e("Updated garden registry in localStorage."),e("Deletion complete. Reloading..."),setTimeout(()=>{const n=decodeURIComponent(window.location.pathname.split("/").pop()||"home");if(o.includes(n)||s.length===0){const i=new URL(import.meta.url).pathname,a=i.lastIndexOf("/src/"),r=a>-1?i.substring(0,a):"";window.location.href=`${window.location.origin}${r}/home`}else window.location.reload()},2e3)}class It{constructor(){const e=new URLSearchParams(window.location.search);this.isEnabled=e.has("debug"),console.log(`[DEBUG] Debug mode is ${this.isEnabled?"ENABLED":"DISABLED"}`)}log(...e){this.isEnabled&&console.log("[DEBUG]",...e)}error(...e){this.isEnabled&&console.error("[DEBUG]",...e)}warn(...e){this.isEnabled&&console.warn("[DEBUG]",...e)}}const w=new It;class Dt{constructor(e){this.signaling=e}connectToSignalingServer(){return new Promise((e,t)=>{const s=this.signaling.signalingServerUrl;if(this.signaling.ws&&this.signaling.ws.readyState===WebSocket.OPEN){e();return}this.signaling.ws=new WebSocket(s),this.signaling.ws.onopen=()=>{w.log(`Connected to signaling server at ${s}`),e()},this.signaling.ws.onclose=()=>{w.log("Disconnected from signaling server"),this.signaling.sync.disconnect()},this.signaling.ws.onerror=n=>{w.error("WebSocket error:",n),this.signaling.sync.updateConnectionState("error","Signaling server connection error."),t(new Error(`Failed to connect to signaling server at ${s}`))},this.signaling.ws.onmessage=n=>{try{const i=JSON.parse(n.data);this.signaling._signalingMessageHandler&&this.signaling._signalingMessageHandler.handleSignalingMessage(i)}catch(i){w.error("Error parsing signaling message:",i)}}})}sendJoinSessionRequest(e){const t=this.signaling.ws;t&&t.readyState===WebSocket.OPEN?t.send(JSON.stringify({type:"join_session",sessionId:e})):w.error("Cannot send join session request, WebSocket is not open.")}sendSignal(e,t){const s=this.signaling.ws;s&&s.readyState===WebSocket.OPEN&&s.send(JSON.stringify({type:"signal",target:t,data:e}))}}class Nt{constructor(e){this.signaling=e}handleSignalingMessage(e){const t=this.signaling.sync;switch(e.type){case"welcome":this.signaling.peerId=e.peerId,t.updateConnectionState("connected-signal","Connected to tracker, waiting for peers...");break;case"peer_list":e.peers.forEach(s=>{this.signaling.connectToPeer(s)});break;case"peer_joined":this.signaling.connectToPeer(e.peerId);break;case"signal":e.from&&e.data&&this.signaling.handleSignal(e.from,e.data);break;case"peer_left":e.peerId&&t.handlePeerLeft(e.peerId);break;case"error":t.updateConnectionState("error",`Signaling error: ${e.message}`);break}}}const Rt=500;class At{constructor(e){this.signaling=e,this.sync=e.sync,this.seenMessages=new Set}handleIncomingMessage(e,t){if(!e.payload||!e.messageId){w.warn("Received a message without a payload or messageId, cannot process.",e);return}if(this.seenMessages.has(e.messageId))return;if(this.seenMessages.add(e.messageId),this.seenMessages.size>Rt){const n=this.seenMessages.values().next().value;this.seenMessages.delete(n)}this.sendSyncMessage(e.payload,null,e.messageId);const s=e.payload;switch(s.type){case"peer_introduction":this.sync.handlePeerIntroduction(s);break;default:this.sync.fileSync&&this.sync.fileSync.handleSyncMessage(s);break}}sendSyncMessage(e,t=null,s=null){const n=s||crypto.randomUUID(),a=JSON.stringify({messageId:n,payload:e});if(this.seenMessages.add(n),t){const r=this.sync.peerConnections.get(t);r&&r.dataChannel&&r.dataChannel.readyState==="open"&&r.dataChannel.send(a)}else this.sync.peerConnections.forEach(r=>{r.dataChannel&&r.dataChannel.readyState==="open"&&r.dataChannel.send(a)})}destroy(){this.seenMessages.clear()}}class _t{constructor(e){this.signaling=e}async connectToPeer(e){const t=this.signaling.sync,s=t.createPeerConnection(e,!0);if(s)try{const n=s.createDataChannel("syncChannel");t.setupDataChannel(e,n);const i=await s.createOffer();await s.setLocalDescription(i),this.signaling.sendSignal({type:"offer",sdp:i.sdp},e)}catch(n){w.error(`Failed to initiate connection to ${e}:`,n)}}}class Ot{constructor(e){this.sync=e,this.ws=null,this.signalingServerUrl=localStorage.getItem("thoughtform_signaling_server")||"wss://socket.thoughtform.garden",this.peerId=null,this._webSocketManager=new Dt(this),this._signalingMessageHandler=new Nt(this),this._webrtcInitiator=new _t(this),this._syncMessageRouter=new At(this)}updateSignalingServerUrl(e){this.signalingServerUrl=e,localStorage.setItem("thoughtform_signaling_server",e)}async joinSession(e){try{await this._webSocketManager.connectToSignalingServer(),this._webSocketManager.sendJoinSessionRequest(e)}catch{this.sync.updateConnectionState("error","Failed to connect to signaling server.")}}connectToPeer(e){e!==this.peerId&&this.peerId>e&&this._webrtcInitiator.connectToPeer(e)}sendSignal(e,t){this._webSocketManager.sendSignal(e,t)}async handleSignal(e,t){const s=this.sync;try{let n=s.peerConnections.get(e);if(!n)if(t.type==="offer"){if(n=s.createPeerConnection(e,!1),!n){console.warn(`[SYNC-SIGNAL] Received offer from ${e.substring(0,8)} but at connection limit. Ignoring.`);return}}else{w.warn(`[SYNC-SIGNAL] Received signal from unknown peer ${e.substring(0,8)} before an offer. Discarding.`);return}if(t.type==="offer"){await n.setRemoteDescription(new RTCSessionDescription(t));const i=await n.createAnswer();await n.setLocalDescription(i),this.sendSignal({type:"answer",sdp:i.sdp},e)}else t.type==="answer"?await n.setRemoteDescription(new RTCSessionDescription(t)):t.type==="candidate"&&await n.addIceCandidate(new RTCIceCandidate(t.candidate))}catch(n){w.error(`Error handling signal from ${e}:`,n)}}sendSyncMessage(e,t,s){this._syncMessageRouter.sendSyncMessage(e,t,s)}handleIncomingMessage(e,t){this._syncMessageRouter.handleIncomingMessage(e,t)}destroy(){this.ws&&(this.ws.close(),this.ws=null),this._syncMessageRouter.destroy()}}class Bt{constructor(){this._listeners={}}addEventListener(e,t){e in this._listeners||(this._listeners[e]=[]),this._listeners[e].push(t)}removeEventListener(e,t){if(!(e in this._listeners))return;const s=this._listeners[e];for(let n=0,i=s.length;n<i;n++)if(s[n]===t){s.splice(n,1);return}}dispatchEvent(e){if(!(e.type in this._listeners))return!0;const t=this._listeners[e.type].slice();for(let s=0,n=t.length;s<n;s++)t[s].call(this,e);return!e.defaultPrevented}destroy(){this._listeners={}}}class Ut{static getGitClient(e){if(e.gitClient)return e.gitClient;if(e.sync&&e.sync.gitClient)return e.sync.gitClient;if(window.thoughtform){for(const t in window.thoughtform)if(window.thoughtform[t]&&typeof window.thoughtform[t]=="object"){if(window.thoughtform[t].hasOwnProperty("readFile")&&window.thoughtform[t].hasOwnProperty("writeFile"))return w.log(`DEBUG: Found potential gitClient-like object at window.thoughtform.${t}`),window.thoughtform[t];if(window.thoughtform[t].gitClient)return w.log(`DEBUG: Found gitClient at window.thoughtform.${t}.gitClient`),window.thoughtform[t].gitClient}if(window.thoughtform.gitClient)return w.log("DEBUG: Found gitClient at window.thoughtform.gitClient"),window.thoughtform.gitClient;if(window.thoughtform.editor&&window.thoughtform.editor.gitClient)return w.log("DEBUG: Found gitClient at window.thoughtform.editor.gitClient"),window.thoughtform.editor.gitClient}return w.log("DEBUG: _getGitClient: No gitClient found in standard locations or window.thoughtform"),null}}class qt{static setupDataChannel(e,t){t.onopen=()=>{e.sync.isConnected=!0,e.sync.ui.showMessages(),e.sync.addMessage("File sync data channel is open."),w.log("DEBUG: SyncFiles confirmed data channel is open.")},t.onmessage=async s=>{try{const n=JSON.parse(s.data);await e.sync._handleIncomingSyncMessage(n,"P2P")}catch(n){console.error("Error parsing sync message from DataChannel:",n,"Raw data:",s.data)}},t.onclose=()=>{e.sync.isConnected=!1,e.sync.ui.hideMessages(),e.sync.addMessage("File sync data channel closed."),w.log("DEBUG: SyncFiles confirmed data channel is closed.")},t.onerror=s=>{const n=s.error;n&&n.name==="OperationError"&&n.message.includes("User-Initiated Abort")?w.log("Data channel closed intentionally by a peer.",s):(console.error("Data channel error:",s),e.sync.addMessage("Data channel error: "+(n?n.message:"Unknown error")))}}}class fe{static async _listAllFiles(e,t){const s=e.pfs;if(!s)throw new Error("gitClient does not have pfs property");let n=[];try{const i=await s.readdir(t);for(const a of i){if(a===".git")continue;const r=t==="/"?`/${a}`:`${t}/${a}`;try{(await s.stat(r)).isDirectory()?n=n.concat(await this._listAllFiles(e,r)):n.push(r)}catch(c){w.warn(`Could not stat ${r}, skipping.`,c)}}}catch(i){w.log(`Directory not readable: ${t}`,i)}return n}static async handleFileUpdate(e,t){e.incrementPendingWrites();try{if(!t.gardenName)throw new Error("Received file update without a gardenName during a full sync.");const s=new P(t.gardenName);if(t.isFullSync){e.deletedGitDirs.has(t.gardenName)||(e.deletedGitDirs.add(t.gardenName),e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Preparing to receive garden: ${t.gardenName}...`,type:"info"}})),await s.initRepo(),e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Replacing git history for ${t.gardenName}...`,type:"info"}})),await s.rmrf("/.git")),e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Writing: ${t.path.substring(1)} (${t.gardenName})`,type:"info"}}));const n=Buffer.from(t.content,"base64");await s.writeFile(t.path,n)}else{const n=t.isBase64?Buffer.from(t.content,"base64"):t.content;await s.writeFile(t.path,n),e.sync.addMessage(`Updated file: ${t.path} in garden ${t.gardenName}`)}}catch(s){console.error("Error handling file update for path:",t.path,s),e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Error updating file ${t.path}: ${s.message}`,type:"error"}}))}finally{e.decrementPendingWrites()}}}class Gt{static async handleSyncMessage(e,t){switch(t.type){case"file_update":await fe.handleFileUpdate(e,t);break;case"request_gardens":await this.handleRequestGardens(e,t.gardens);break;case"full_sync_complete":e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:"File stream complete. Waiting for writes to finish...",type:"info"}})),e.markSyncStreamAsComplete();break;default:w.log("Unknown sync message type:",t.type)}}static async handleRequestGardens(e,t=[]){if(!(!t||t.length===0)){e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Received request for gardens: ${t.join(", ")}.`,type:"info"}}));try{for(const s of t){const n=new P(s),i=await n.listAllFilesForClone("/");e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Found ${i.length} files in ${s}. Starting stream...`,type:"info"}}));const a=200;let r=0;for(let c=0;c<i.length;c+=a){const l=i.slice(c,c+a),d=await Promise.all(l.map(h=>n.readFileAsBuffer(h).then(u=>({file:h,content:u}))));for(const{file:h,content:u}of d)u&&e.sync.sendSyncMessage({type:"file_update",gardenName:s,path:h,content:Buffer.from(u).toString("base64"),isBase64:!0,isFullSync:!0});r+=l.length,e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Sent ${r} of ${i.length} files for ${s}...`,type:"info"}}))}}e.sync.sendSyncMessage({type:"full_sync_complete"}),e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:"All file data sent.",type:"info"}}))}catch(s){console.error("Error handling garden request:",s),e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Error handling garden request: ${s.message}`,type:"error"}}))}}}}class se{static async syncAllFiles(e){e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:"Starting to send all files...",type:"info"}}));const t=e._getGitClient();if(!t){e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:"Error: Git client not available.",type:"error"}}));return}try{if(!await b.confirm({title:"Send All Files",message:"This will send your working files to the peer. It will NOT send your git history. Are you sure?",okText:"Send Files"})){e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:"Send all files cancelled.",type:"cancelled"}}));return}const n=await e.getAllFiles(t);e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Found ${n.length} content files to sync.`,type:"info"}}));for(const i of n){const a=await t.readFile(i);let r=0;try{r=JSON.parse(a).lastupdated||0}catch{}e.sync.sendSyncMessage({type:"file_update",path:i,content:a,timestamp:r,isFullSync:!1})}e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Sync completed. Sent ${n.length} files.`,type:"complete"}}))}catch(s){e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Error syncing all files: ${s.message}`,type:"error"}}))}}static requestSpecificGardens(e,t){e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:"Requesting selected gardens from peers...",type:"info"}})),Object.entries(t).forEach(([s,n])=>{const i=s.substring(0,8);e.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:`Sending request to peer ${i}... for gardens: ${n.join(", ")}`,type:"info"}})),e.sync.sendSyncMessage({type:"request_gardens",gardens:n},s)}),e.sync.addMessage(`Sent requests for ${Object.keys(t).length} peer(s).`)}static sendFileUpdate(e,t,s,n){e.sync.sendSyncMessage({type:"file_update",path:t,content:s,timestamp:n})}}class Ht extends Bt{constructor(e){super(),this.sync=e,this.gitClient=null,this.pendingWriteCount=0,this.isSyncCompleteMessageReceived=!1,this.deletedGitDirs=new Set}resetFullSyncState(){this.pendingWriteCount=0,this.isSyncCompleteMessageReceived=!1,this.deletedGitDirs.clear()}_getGitClient(){return Ut.getGitClient(this)}setGitClient(e){this.gitClient=e}setupDataChannel(e){qt.setupDataChannel(this,e)}async handleSyncMessage(e){await Gt.handleSyncMessage(this,e)}async syncAllFiles(){this.resetFullSyncState(),await se.syncAllFiles(this)}requestSpecificGardens(e){this.resetFullSyncState(),se.requestSpecificGardens(this,e)}incrementPendingWrites(){this.pendingWriteCount++}decrementPendingWrites(){this.pendingWriteCount--,this.checkForReload()}markSyncStreamAsComplete(){this.isSyncCompleteMessageReceived=!0,this.checkForReload()}checkForReload(){this.isSyncCompleteMessageReceived&&this.pendingWriteCount===0&&(this.dispatchEvent(new CustomEvent("syncProgress",{detail:{message:"All files received and written. Reloading...",type:"complete"}})),setTimeout(()=>window.location.reload(),1500))}destroy(){super.destroy()}async getAllFiles(e){return fe._listAllFiles(e,"/")}}class Wt{constructor(e){this.sync=e,this.syncMethodIndicatorEl=null,this.syncProgressModal=null,this.syncProgressLogArea=null,this.syncProgressFinalMessageArea=null,this.syncProgressActionButton=null,this.connectBtn=null,this.nameInput=null,this.autoConnectCheckbox=null}render(){this.sync._container&&(this.sync._container.innerHTML=`
        <div class="sync-container">
          <div class="sync-panel">
              <h3>Signaling Server</h3>
              <div class="sync-row">
                <label for="signaling-server-url" class="sync-label">Server URL:</label>
                <input type="text" id="signaling-server-url" class="eruda-input flex-grow" value="${this.sync.signaling.signalingServerUrl}">
                <button id="save-signaling-config" class="eruda-button">Save</button>
              </div>
            </div>
            <div class="sync-panel">
              <h3>Sync Configuration</h3>
              <div class="sync-row">
                <label for="sync-name-input" class="sync-label">Sync Name:</label>
                <input type="text" id="sync-name-input" class="eruda-input" placeholder="e.g., my-devices">
                <button id="sync-connect-btn" class="eruda-button">Connect</button>
              </div>
              <div class="sync-row space-between">
                <label class="flex-center">
                  <input type="checkbox" id="sync-autoconnect-checkbox">
                  <span>Auto-connect on startup</span>
                </label>
              </div>
            </div>
            <div class="sync-panel">
                <div class="sync-status-grid">
                    <strong>Status:</strong> <span id="sync-status">Disconnected</span>
                    <strong>Method:</strong> <span id="sync-method-indicator">None</span>
                    <!-- THIS IS THE FIX: Added the missing peer count element -->
                    <strong>Peers:</strong> <span id="sync-peer-count">0</span>
                </div>
            </div>
            <div class="sync-panel sync-actions">
              <h4>File Sync Actions</h4>
              <div class="sync-row">
                <button id="sync-all-files-btn" class="eruda-button">Send All Files</button>
                <button id="request-all-files-btn" class="eruda-button">Request from Peer...</button>
              </div>
            </div>
            <div class="sync-messages-container hidden" id="eruda-sync-messages">
              <h3>Messages</h3>
              <div id="eruda-messages-list" class="sync-messages-list"></div>
            </div>
        </div>
      `,this.syncMethodIndicatorEl=this.sync._container.querySelector("#sync-method-indicator"),this.connectBtn=this.sync._container.querySelector("#sync-connect-btn"),this.nameInput=this.sync._container.querySelector("#sync-name-input"),this.autoConnectCheckbox=this.sync._container.querySelector("#sync-autoconnect-checkbox"))}bindEvents(){if(!this.sync._container){w.error("SyncUI.bindEvents: Container not set");return}this.nameInput.value=localStorage.getItem("thoughtform_sync_name")||"",this.autoConnectCheckbox.checked=localStorage.getItem("thoughtform_sync_auto_connect")==="true",this.connectBtn.addEventListener("click",()=>{const n=this.sync.connectionState;if(n==="disconnected"||n==="error"){const i=this.nameInput.value.trim(),a=this.autoConnectCheckbox.checked;if(!i){this.addMessage("Please enter a Sync Name.");return}localStorage.setItem("thoughtform_sync_name",i),localStorage.setItem("thoughtform_sync_auto_connect",a),this.sync.connect(i)}else this.sync.disconnect()});const e=this.sync._container.querySelector("#save-signaling-config");e&&e.addEventListener("click",()=>{const n=this.sync._container.querySelector("#signaling-server-url"),i=n?n.value.trim():"";i?(this.sync.signaling.updateSignalingServerUrl(i),this.addMessage(`Signaling server updated to: ${i}`)):this.addMessage("Please enter a valid signaling server URL.")});const t=this.sync._container.querySelector("#sync-all-files-btn"),s=this.sync._container.querySelector("#request-all-files-btn");t&&t.addEventListener("click",async()=>{this.showSyncProgressModal(),await this.sync.fileSync.syncAllFiles()}),s&&s.addEventListener("click",async()=>{const n=await b.selection({title:"Request Gardens from Peers",peerData:this.sync.connectedPeers});n?(w.log("User made selection:",n),this.showSyncProgressModal(),this.sync.fileSync.requestSpecificGardens(n)):w.log("Garden request cancelled by user.")})}updateStatus(e){const t=this.sync._container.querySelector("#sync-status");t&&(t.textContent=e);const s=this.sync._container.querySelector("#sync-peer-count");s&&(s.textContent=this.sync.connectedPeers.size)}updateControls(e){const t=e==="disconnected"||e==="error",s=e==="connecting";this.connectBtn&&(this.connectBtn.disabled=s,t?this.connectBtn.textContent="Connect":s?this.connectBtn.textContent="Connecting...":this.connectBtn.textContent="Disconnect"),this.nameInput&&(this.nameInput.disabled=!t),this.autoConnectCheckbox&&(this.autoConnectCheckbox.disabled=!t);const n=e==="connected-p2p"||e==="connected-signal";this.sync._container.querySelectorAll(".sync-actions button").forEach(i=>i.disabled=!n)}updateConnectionIndicator(e){const t=document.querySelector('.luna-tab-item[data-id="Sync"]');if(t){t.classList.remove("sync-status-connecting","sync-status-p2p","sync-status-signal","sync-status-error");let s="None",n="var(--color-text-secondary)";switch(e){case"connecting":t.classList.add("sync-status-connecting"),s="Connecting...",n="var(--base-accent-warning)";break;case"connected-signal":t.classList.add("sync-status-signal"),s="WebSocket (Fallback)",n="var(--base-accent-warning)";break;case"connected-p2p":t.classList.add("sync-status-p2p"),s="WebRTC (P2P)",n="var(--base-accent-action)";break;case"error":t.classList.add("sync-status-error"),s="Error",n="var(--base-accent-destructive)";break}this.syncMethodIndicatorEl&&(this.syncMethodIndicatorEl.textContent=s,this.syncMethodIndicatorEl.style.color=n)}}addMessage(e){const t=this.sync._container.querySelector("#eruda-messages-list");if(t){const s=document.createElement("div");s.textContent=e,t.appendChild(s),t.scrollTop=t.scrollHeight}}showMessages(){const e=this.sync._container.querySelector("#eruda-sync-messages");e&&(e.style.display="block")}hideMessages(){const e=this.sync._container.querySelector("#eruda-sync-messages");e&&(e.style.display="none")}showSyncProgressModal(){this.syncProgressModal&&this.syncProgressModal.destroy(),this.syncProgressModal=new b({title:"File Sync Progress"}),this.syncProgressModal.updateContent(`
      <div id="sync-progress-log" style="height: 300px; overflow-y: auto; border: 1px solid var(--color-border-primary); padding: 1rem; background-color: var(--base-dark); margin-bottom: 1rem;"></div>
      <div id="sync-progress-final-message" style="font-weight: bold; padding: 5px; min-height: 20px;"></div>
    `),this.syncProgressLogArea=this.syncProgressModal.content.querySelector("#sync-progress-log"),this.syncProgressFinalMessageArea=this.syncProgressModal.content.querySelector("#sync-progress-final-message"),this.syncProgressActionButton=null,this.syncProgressModal.show()}updateSyncProgress(e){if(!this.syncProgressModal||!this.syncProgressLogArea)return;const{message:t="No message",type:s="info"}=e.detail,n=document.createElement("div"),i=new Date().toLocaleTimeString();switch(n.textContent=`[${i}] ${t}`,n.style.marginBottom="5px",s){case"error":n.style.color="var(--base-accent-destructive)";break;case"complete":n.style.color="var(--base-accent-action)";break;case"cancelled":n.style.color="var(--base-accent-warning)";break;default:n.style.color="var(--color-text-primary)";break}this.syncProgressLogArea.appendChild(n),this.syncProgressLogArea.scrollTop=this.syncProgressLogArea.scrollHeight,["complete","error","cancelled"].includes(s)&&(this.syncProgressFinalMessageArea&&(this.syncProgressFinalMessageArea.textContent=t,this.syncProgressFinalMessageArea.style.color=n.style.color),this.syncProgressActionButton&&this.syncProgressActionButton.remove(),(s==="error"||s==="cancelled")&&(this.syncProgressActionButton=this.syncProgressModal.addFooterButton("Close",()=>this.hideSyncProgressModal()),s==="error"&&this.syncProgressActionButton.classList.add("destructive")))}hideSyncProgressModal(){this.syncProgressModal&&(this.syncProgressModal.destroy(),this.syncProgressModal=null)}}const ne=5;class jt{constructor(){this.name="sync",this._container=null,this.peerConnections=new Map,this.isConnected=!1,this.gitClient=null,this.connectionState="disconnected",this.syncName=null,this.connectedPeers=new Map,this.signaling=new Ot(this),this.fileSync=new Ht(this),this.ui=new Wt(this)}init(e){this._container=e,this._container.style.padding="1rem",this._container.style.overflowY="auto",this.ui.render(),this.ui.bindEvents(),this.ui.updateControls(this.connectionState),this.ui.updateConnectionIndicator(this.connectionState),this.fileSync&&this.ui&&this.fileSync.addEventListener("syncProgress",this.ui.updateSyncProgress.bind(this.ui));const t=localStorage.getItem("thoughtform_sync_auto_connect")==="true",s=localStorage.getItem("thoughtform_sync_name");t&&s&&this.connect(s)}async connect(e){this.connectionState!=="disconnected"&&this.connectionState!=="error"||(this.syncName=e,this.updateConnectionState("connecting","Connecting..."),await this.signaling.joinSession(this.syncName))}disconnect(){this.signaling.destroy(),this.peerConnections.forEach(e=>e.close()),this.peerConnections.clear(),this.isConnected=!1,this.syncName=null,this.connectedPeers.clear(),this.updateConnectionState("disconnected","Disconnected")}createPeerConnection(e,t=!1){if(this.peerConnections.has(e))return this.peerConnections.get(e);if(this.peerConnections.size>=ne)return console.warn(`[SYNC-PC] Max connections (${ne}) reached. Not connecting to ${e.substring(0,8)}...`),null;const s=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return this.peerConnections.set(e,s),s.onicecandidate=n=>{n.candidate&&this.signaling.sendSignal({type:"candidate",candidate:n.candidate},e)},s.onconnectionstatechange=()=>{const n=s.connectionState;n==="connected"?this.updateConnectionState("connected-p2p",`P2P Connected (${this.peerConnections.size} peers)`):(n==="failed"||n==="disconnected"||n==="closed")&&this.handlePeerLeft(e)},t||(s.ondatachannel=n=>{this.setupDataChannel(e,n.channel)}),s}setupDataChannel(e,t){const s=this.peerConnections.get(e);s&&(s.dataChannel=t,t.onopen=()=>{this._announcePresence(e)},t.onmessage=async n=>{try{const i=JSON.parse(n.data);await this._handleIncomingSyncMessage(i,`P2P-${e.substring(0,4)}`)}catch(i){console.error("Error parsing sync message from DataChannel:",i)}},t.onclose=()=>this.handlePeerLeft(e),t.onerror=n=>{const i=n.error;i&&i.name==="OperationError"&&i.message.includes("User-Initiated Abort")?w.log(`Data channel for peer ${e.substring(0,8)} closed intentionally.`):console.error(`Data channel error with ${e.substring(0,8)}...:`,n)})}updateConnectionState(e,t){this.connectionState=e,this.isConnected=e==="connected-p2p"||e==="connected-signal",this.ui&&(t&&this.ui.updateStatus(t),this.ui.updateConnectionIndicator(e),this.ui.updateControls(e))}_handleIncomingSyncMessage(e,t){this.signaling.handleIncomingMessage(e,t)}_announcePresence(e=null){if(!this.signaling.peerId)return;const t=localStorage.getItem("thoughtform_gardens"),s=t?JSON.parse(t):["home"];this.sendSyncMessage({type:"peer_introduction",peerId:this.signaling.peerId,gardens:s},e)}handlePeerIntroduction(e){if(!e.peerId||e.peerId===this.signaling.peerId)return;const t=!this.connectedPeers.has(e.peerId);this.connectedPeers.set(e.peerId,{gardens:e.gardens}),t&&this.addMessage(`Peer ${e.peerId.substring(0,8)}... discovered.`),this.ui&&this.ui.updateStatus(`P2P Connected (${this.connectedPeers.size} peer${this.connectedPeers.size===1?"":"s"})`)}handlePeerLeft(e){this.connectedPeers.has(e)&&(this.connectedPeers.delete(e),this.addMessage(`Peer ${e.substring(0,8)}... disconnected.`));const t=this.peerConnections.get(e);t&&t.signalingState!=="closed"?(t.close(),this.peerConnections.delete(e)):this.peerConnections.has(e)&&this.peerConnections.delete(e),this.peerConnections.size===0&&this.connectionState==="connected-p2p"?this.updateConnectionState("connected-signal","Connected to tracker, waiting for peers..."):this.ui&&this.ui.updateStatus(`P2P Connected (${this.connectedPeers.size} total)`)}setGitClient(e){this.gitClient=e,this.fileSync.setGitClient(e)}addMessage(e){this.ui&&this.ui.addMessage(e)}sendSyncMessage(e,t=null,s=null){this.signaling.sendSyncMessage(e,t,s)}show(){this._container&&(this._container.style.display="block")}hide(){this._container&&(this._container.style.display="none")}destroy(){this.disconnect(),this.fileSync&&this.fileSync.destroy()}}function G(o,e,t=!0){const s=e.map(n=>`
    <label>
      <input type="checkbox" class="garden-select-checkbox" value="${n}" ${t?"checked":""}>
      <span>${n}</span>
    </label>
  `).join("");return`
    <div>
      <p>${o}</p>
      <div>
        <button type="button" class="select-all-btn">Select All</button>
        <button type="button" class="select-none-btn">Deselect All</button>
      </div>
      <div class="garden-selection-list">
        ${s}
      </div>
    </div>
  `}function zt(){const o=document.getElementById("eruda-container");if(!o)return;F.init({container:o,tool:["console","elements","network","resources"],inline:!0,useShadowDom:!1});const e=F.get("console");return e&&e.config.set("maxLogNum",2e3),window.thoughtform&&(window.thoughtform.eruda=F),setTimeout(()=>{const t=o.querySelector(".luna-tab-item")?.parentElement;t&&t.addEventListener("click",s=>{const n=s.target.closest(".luna-tab-item");if(n){const i=n.innerText.toLowerCase();window.thoughtform.ui.toggleDevtools?.(!0,i)}})},500),setTimeout(()=>{const t=o.querySelector(".eruda-elements");if(!t)return;let s=!1;new MutationObserver(()=>{const i=t.style.display!=="none";if(i&&!s){const a=document.querySelector(".eruda-control > .eruda-icon-select");a&&(a.click(),a.click())}s=i}).observe(t,{attributes:!0,attributeFilter:["style"]})},500),F.add({name:"Data",init(t){this._$el=t,t.html(`
        <div>
          <h2>Data Portability</h2>
          <button id="export-btn" class="eruda-button">Export...</button>
          <button id="import-btn" class="eruda-button">Import...</button>
          <input type="file" id="import-file-input" accept=".zip" style="display: none;">

          <hr>

          <h2>Danger Zone</h2>
          <p>
            <button id="clear-data-btn" class="eruda-button destructive">Clear Data...</button>
          </p>
        </div>
      `);const s=t.find("#export-btn")[0],n=t.find("#import-btn")[0],i=t.find("#import-file-input")[0],a=t.find("#clear-data-btn")[0];s.addEventListener("click",()=>{const r=localStorage.getItem("thoughtform_gardens"),c=r?JSON.parse(r):["home"],l=new b({title:"Select Gardens to Export"});l.updateContent(G("Choose which gardens to include in the export:",c));const d=l.content;d.querySelector(".select-all-btn").onclick=()=>d.querySelectorAll(".garden-select-checkbox").forEach(u=>u.checked=!0),d.querySelector(".select-none-btn").onclick=()=>d.querySelectorAll(".garden-select-checkbox").forEach(u=>u.checked=!1);const h=async()=>{const u=Array.from(d.querySelectorAll(".garden-select-checkbox:checked")).map(v=>v.value);l.destroy();const g=new b({title:"Exporting Gardens..."});g.updateContent("<p>Preparing export. Please wait...</p>");let m=!1,y="";g.addFooterButton("Cancel",()=>{m=!0,g.destroy(),console.log("Export cancelled by user.")}),g.show();try{await $t(u,v=>{if(m)throw new Error("Export cancelled by user.");console.log(v),y+=v+"<br>",g.updateContent(`<div style="font-family: monospace; max-height: 300px; overflow-y: auto;">${y}</div>`)}),m||(g.clearFooter(),g.updateContent("<p>Export complete! The download will begin shortly.</p>"),setTimeout(()=>g.destroy(),3e3))}catch(v){m||(console.error("Export failed:",v.message),g.clearFooter(),g.updateContent(`<p style="color: #F44747;"><strong>Export Failed</strong><br>${v.message}</p>`),g.addFooterButton("Close",()=>g.destroy()))}};l.addFooterButton("Export Selected",h),l.addFooterButton("Cancel",()=>l.destroy()),l.show()}),n.addEventListener("click",()=>i.click()),i.addEventListener("change",async()=>{const r=i.files[0];if(!r)return;const c=new b({title:"Select Gardens to Import"});c.updateContent("Scanning zip file..."),c.show();try{const l=await Tt(r);if(l.length===0){c.updateContent("No valid gardens found in this zip file."),c.addFooterButton("Close",()=>c.destroy());return}c.updateContent(G(`Found ${l.length} garden(s). Select which to import:`,l));const d=c.content;d.querySelector(".select-all-btn").onclick=()=>d.querySelectorAll(".garden-select-checkbox").forEach(u=>u.checked=!0),d.querySelector(".select-none-btn").onclick=()=>d.querySelectorAll(".garden-select-checkbox").forEach(u=>u.checked=!1);const h=async()=>{const u=Array.from(d.querySelectorAll(".garden-select-checkbox:checked")).map(m=>m.value);c.clearFooter(),c.updateContent("Starting import...");let g="";try{await Mt(r,u,m=>{g+=`${m}<br>`,c.updateContent(g)})}catch(m){console.error("Import failed:",m),c.updateContent(`<strong>Error during import:</strong><br>${m.message}`),c.addFooterButton("Close",()=>c.destroy())}};c.addFooterButton("Import Selected",h),c.addFooterButton("Cancel",()=>c.destroy())}catch(l){console.error("Failed to read zip file:",l),c.updateContent(`<strong>Error:</strong> Could not read the zip file.<br>${l.message}`),c.addFooterButton("Close",()=>c.destroy())}finally{i.value=""}}),a.addEventListener("click",()=>{const r=localStorage.getItem("thoughtform_gardens"),c=r?JSON.parse(r):[],l=new b({title:"Clear Garden Data"});l.updateContent(G("Select gardens to permanently delete:",c,!1));const d=l.content;d.querySelector(".select-all-btn").onclick=()=>d.querySelectorAll(".garden-select-checkbox").forEach(g=>g.checked=!0),d.querySelector(".select-none-btn").onclick=()=>d.querySelectorAll(".garden-select-checkbox").forEach(g=>g.checked=!1);const h=async()=>{const g=Array.from(d.querySelectorAll(".garden-select-checkbox:checked")).map(y=>y.value);l.clearFooter(),l.updateContent("Starting deletion...");let m="";try{await Ft(g,y=>{m+=`${y}<br>`,l.updateContent(m)})}catch(y){console.error("Deletion failed:",y),l.updateContent(`<strong>Error during deletion:</strong><br>${y.message}`),l.addFooterButton("Close",()=>l.destroy()).classList.add("destructive")}};l.addFooterButton("Delete Selected",h).classList.add("destructive"),l.addFooterButton("Cancel",()=>l.destroy()),l.show()})},show(){this._$el.show()},hide(){this._$el.hide()}}),F.add({name:"Sync",init(t){this.sync=new jt,this.sync.init(t.get(0))},show(){this.sync.show()},hide(){this.sync.hide()},destroy(){this.sync.destroy()}}),F.add({name:"AI",init(t){this._$el=t,t.html(`
        <div style="padding: 10px;">
          <h2>AI Configuration</h2>
          <div class="sync-panel">
            <h3>Google Gemini</h3>
            <div class="sync-row" style="margin-bottom: 10px;">
              <label for="gemini-api-key" class="sync-label">API Key:</label>
              <input type="password" id="gemini-api-key" class="eruda-input flex-grow">
            </div>
            <div class="sync-row">
              <label for="gemini-model-name" class="sync-label">Model Name:</label>
              <input type="text" id="gemini-model-name" class="eruda-input flex-grow" placeholder="e.g., gemini-2.5-flash">
            </div>
          </div>
          <button id="ai-save-config" class="eruda-button" style="margin-top: 15px;">Save</button>
          <div id="ai-save-status" style="margin-top: 10px; color: var(--base-accent-action);"></div>
        </div>
      `);const s=t.find("#gemini-api-key")[0],n=t.find("#gemini-model-name")[0],i=t.find("#ai-save-config")[0],a=t.find("#ai-save-status")[0];s.value=localStorage.getItem("thoughtform_gemini_api_key")||"",n.value=localStorage.getItem("thoughtform_gemini_model_name")||"",i.addEventListener("click",()=>{const r=s.value.trim(),c=n.value.trim();localStorage.setItem("thoughtform_gemini_api_key",r),localStorage.setItem("thoughtform_gemini_model_name",c),window.thoughtform.ai?.loadConfig(),a.textContent="Configuration saved!",setTimeout(()=>{a.textContent=""},3e3)})},show(){this._$el.show()},hide(){this._$el.hide()}}),F}class Vt{constructor({gitClient:e,editor:t}){this.gitClient=e,this.editor=t,this.isOpen=!1,this.query="",this.results=[],this.selectedIndex=0,this.mode="search",this.crossGardenFileCache=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleInput=this.handleInput.bind(this),this.handleResultClick=this.handleResultClick.bind(this),this.close=this.close.bind(this),this.createDOMElements()}createDOMElements(){this.overlay=document.createElement("div"),this.overlay.className="command-overlay hidden",this.overlay.addEventListener("click",this.close),this.container=document.createElement("div"),this.container.className="command-container",this.container.addEventListener("click",e=>e.stopPropagation()),this.titleElement=document.createElement("div"),this.titleElement.className="command-title",this.input=document.createElement("input"),this.input.type="text",this.input.className="command-input",this.input.addEventListener("input",this.handleInput),this.resultsList=document.createElement("ul"),this.resultsList.className="command-results-list",this.resultsList.addEventListener("click",this.handleResultClick),this.container.appendChild(this.titleElement),this.container.appendChild(this.input),this.container.appendChild(this.resultsList),this.overlay.appendChild(this.container),document.body.appendChild(this.overlay)}async _buildCrossGardenIndex(){const e=localStorage.getItem("thoughtform_gardens"),t=e?JSON.parse(e):["home"],s=[];await Promise.all(t.map(async n=>{const i=new P(n),a=await this.editor.sidebar.listFiles(i,"/");for(const r of a)s.push({garden:n,path:r,searchString:`${n} ${r.substring(1)}`.toLowerCase()})})),this.crossGardenFileCache=s}async open(e="search"){if(!this.gitClient||!this.editor){console.error("CommandPalette cannot open: gitClient or editor is not initialized.");return}if(!this.isOpen){if(this.isOpen=!0,this.mode=e,this.mode==="execute"?(this.titleElement.textContent="Executing a File...",this.input.placeholder="Find a .js file to execute..."):(this.titleElement.textContent="Searching Files...",this.input.placeholder="Find file across all gardens..."),this.overlay.classList.remove("hidden"),this.input.focus(),document.addEventListener("keydown",this.handleKeyDown),!this.crossGardenFileCache){const t=this.input.placeholder;this.input.placeholder="Indexing all gardens...",this.input.disabled=!0,await this._buildCrossGardenIndex(),this.input.placeholder=t,this.input.disabled=!1,this.input.focus()}this.search("")}}close(){this.isOpen&&(this.isOpen=!1,this.overlay.classList.add("hidden"),this.input.value="",this.query="",this.results=[],this.selectedIndex=0,document.removeEventListener("keydown",this.handleKeyDown),this.editor&&this.editor.editorView&&this.editor.editorView.focus())}search(e){this.query=e.toLowerCase();let t=this.crossGardenFileCache;this.mode==="execute"&&(t=this.crossGardenFileCache.filter(s=>s.garden===this.gitClient.gardenName&&s.path.endsWith(".js"))),this.query?this.results=t.filter(s=>{let n=0,i=0;for(;n<this.query.length&&i<s.searchString.length;)this.query[n]===s.searchString[i]&&n++,i++;return n===this.query.length}).sort((s,n)=>{const i=s.garden===this.gitClient.gardenName,a=n.garden===this.gitClient.gardenName;return i&&!a?-1:!i&&a?1:0}):this.results=(this.mode==="execute"?t:t.filter(s=>s.garden===this.gitClient.gardenName)).slice(0,100),this.selectedIndex=0,this.renderResults()}renderResults(){if(this.resultsList.innerHTML="",this.results.length===0){this.resultsList.innerHTML='<li class="command-no-results">No matches found</li>';return}this.results.forEach((e,t)=>{const s=document.createElement("li");s.className="command-result-item",s.dataset.index=t;const n=e.path.startsWith("/")?e.path.substring(1):e.path;e.garden!==this.gitClient.gardenName?s.innerHTML=`<span class="command-path">${n}</span> <span class="command-garden">${e.garden}</span>`:s.textContent=n,t===this.selectedIndex&&(s.classList.add("active"),s.scrollIntoView({block:"nearest"})),this.resultsList.appendChild(s)})}async selectItem(e){if(e<0||e>=this.results.length)return;const t=this.results[e];if(this.mode==="execute"){this.close();try{const s=await this.gitClient.readFile(t.path),i=await new Function("editor","git",s)(this.editor,this.gitClient);console.log(`Execution successful for ${t.path}. Result:`,i)}catch(s){console.error(`Execution failed for ${t.path}:`,s),window.thoughtform.ui.toggleDevtools?.(!0,"console")}}else{if(t.garden!==this.gitClient.gardenName){const s=new URL(import.meta.url).pathname,n=s.lastIndexOf("/src/"),i=n>-1?s.substring(0,n):"";window.location.href=`${window.location.origin}${i}/${encodeURIComponent(t.garden)}#${encodeURIComponent(t.path)}`}else window.location.hash=`#${encodeURIComponent(t.path)}`;this.close()}}handleInput(e){this.search(e.target.value)}handleResultClick(e){const t=e.target.closest(".command-result-item");t&&this.selectItem(parseInt(t.dataset.index,10))}handleKeyDown(e){if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),this.selectedIndex=(this.selectedIndex+1)%this.results.length,this.renderResults();break;case"ArrowUp":e.preventDefault(),this.selectedIndex=(this.selectedIndex-1+this.results.length)%this.results.length,this.renderResults();break;case"Enter":e.preventDefault(),this.results.length>0&&this.selectItem(this.selectedIndex);break;case"Escape":e.preventDefault(),this.close();break}}}async function pe(o,e){const t=o.pfs;let s=[];try{const n=await t.readdir(e);for(const i of n){if(i===".git")continue;const a=`${e==="/"?"":e}/${i}`;try{(await t.stat(a)).isDirectory()?s=s.concat(await pe(o,a)):s.push(a)}catch{console.warn(`[Migration] Could not stat ${a}, skipping.`)}}}catch{console.warn(`[Migration] Could not read directory: ${e}.`)}return s}async function Kt(){console.log("%cStarting Thoughtform data migration...","font-weight: bold; font-size: 1.2em;"),console.log("This will convert all files from the old JSON format to raw content. This only needs to be run once.");const o=localStorage.getItem("thoughtform_gardens"),e=o?JSON.parse(o):["home"];if(e.length===0){console.log("No gardens found to migrate.");return}let t=0,s=0;for(const n of e){console.log(`%cProcessing garden: "${n}"`,"font-weight: bold; color: blue;");const i=new P(n),a=await pe(i,"/");if(a.length===0){console.log("No files found in this garden.");continue}for(const r of a){t++;try{const c=await i.readFile(r);let l;try{l=JSON.parse(c)}catch{console.log(`- ${r} is not in JSON format, skipping.`);continue}if(l&&typeof l.content<"u"){const d=l.content;c!==d?(console.log(`%c  MIGRATING: ${r}`,"color: green;"),await i.writeFile(r,d),s++):console.log(`- ${r} content is already raw, skipping.`)}else console.log(`- ${r} is valid JSON but not the old format, skipping.`)}catch(c){console.error(`%c  ERROR: Failed to process ${r}.`,"color: red;",c)}}}console.log("%cMigration complete!","font-weight: bold; font-size: 1.2em;"),console.log(`Checked ${t} files across ${e.length} garden(s).`),console.log(`Migrated ${s} files.`),console.log("You should now refresh the page.")}async function Jt(o,e,t){const s=`https://generativelanguage.googleapis.com/v1beta/models/${e}:streamGenerateContent?key=${o}&alt=sse`,n={contents:[{parts:[{text:t}]}]};try{const i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!i.ok){const c=await i.json();throw console.error("Gemini API Error:",c),new Error(`API request failed: ${c.error?.message||i.statusText}`)}const a=i.body.getReader(),r=new TextDecoder;return new ReadableStream({async pull(c){for(;;){const{done:l,value:d}=await a.read();if(l){c.close();break}const u=r.decode(d,{stream:!0}).split(`
`);for(const g of u)if(g.startsWith("data: "))try{const m=g.substring(5).trim(),v=JSON.parse(m)?.candidates?.[0]?.content?.parts?.[0]?.text;v&&c.enqueue(v)}catch{}}}})}catch(i){throw console.error("Failed to fetch from Gemini API:",i),i}}class Yt{constructor(){this.config={geminiApiKey:"",geminiModelName:"gemini-2.5-flash"},this.loadConfig()}loadConfig(){this.config.geminiApiKey=localStorage.getItem("thoughtform_gemini_api_key")||"";const e=localStorage.getItem("thoughtform_gemini_model_name");this.config.geminiModelName=e||"gemini-2.5-flash"}saveConfig(e,t){localStorage.setItem("thoughtform_gemini_api_key",e||""),localStorage.setItem("thoughtform_gemini_model_name",t||""),this.loadConfig()}async getCompletion(e){if(this.loadConfig(),!this.config.geminiApiKey)throw new Error("Gemini API key is not set. Please configure it in the AI dev tools panel.");return Jt(this.config.geminiApiKey,this.config.geminiModelName,e)}async handleAiChatRequest(e){let t=-1;const s="🤖 Thinking...";try{const n=e.state.selection.main.head,i=e.state.doc.lineAt(n);let a=i.number;for(;a>1&&e.state.doc.line(a-1).text.trim().startsWith(">");)a--;let r=i.number;for(;r<e.state.doc.lines&&e.state.doc.line(r+1).text.trim().startsWith(">");)r++;const c=e.state.doc.line(a).from,l=e.state.doc.line(r).to;let d=e.state.sliceDoc(c,l);d=d.split(`
`).map(k=>k.trim().substring(1).trim()).join(`
`);const u=`CONTEXT:
---
${e.state.doc.toString()}
---

Based on the context above, respond to the following prompt:

${d}`,g=l,m={changes:{from:g,insert:`

${s}`}};e.dispatch(m),t=g+2;const v=(await this.getCompletion(u)).getReader();let p=!0,C=t;for(;;){const{done:k,value:x}=await v.read();if(k)break;const M=x;p?(e.dispatch({changes:{from:C,to:C+s.length,insert:M}}),C+=M.length,p=!1):(e.dispatch({changes:{from:C,insert:M}}),C+=M.length)}const S=`

`;e.dispatch({changes:{from:C,insert:S},selection:{anchor:C+S.length}})}catch(n){console.error("AI Chat Error:",n),t!==-1&&e.dispatch({changes:{from:t,to:t+s.length,insert:`🚨 Error: ${n.message}`}})}}}function Xt(){return new Yt}window.Buffer=Ce.Buffer;window.process={env:{}};window.thoughtform={ui:{},ai:Xt()};const ye=new URL(import.meta.url).pathname,ie=ye.lastIndexOf("/src/"),z=ie>-1?ye.substring(0,ie):"";let D=window.location.pathname.startsWith(z)?window.location.pathname.substring(z.length):window.location.pathname;D=D.replace(/^\/|\/$/g,"")||"home";D=decodeURIComponent(D);console.log(`Base Path: "${z}"`);console.log(`Loading garden: "${D}"`);const we=new P(D);xt();zt();window.thoughtform.runMigration=Kt;window.onerror=function(o,e,t,s,n){return console.error("Caught global error:",o,n),window.thoughtform.ui.toggleDevtools?.(!0,"console"),!1};window.onunhandledrejection=function(o){console.error("Caught unhandled promise rejection:",o.reason),window.thoughtform.ui.toggleDevtools?.(!0,"console")};const I=new Vt({gitClient:null,editor:null});window.thoughtform.commandPalette=I;const H=new A({target:"main",gitClient:we,commandPalette:I}),Zt=setInterval(()=>{H.isReady&&(clearInterval(Zt),I.gitClient=we,I.editor=H,window.addEventListener("keydown",o=>{if(I.isOpen)return;const t=navigator.platform.toUpperCase().indexOf("MAC")>=0?o.metaKey:o.ctrlKey;let s=!1;if(t)switch(o.key.toLowerCase()){case"p":o.shiftKey?I.open("execute"):I.open("search"),s=!0;break;case"[":window.thoughtform.ui.toggleSidebar?.(),s=!0;break;case"`":window.thoughtform.ui.toggleDevtools?.(null,null),s=!0;break;case"enter":const n=H.editorView;if(n&&n.hasFocus){const i=n.state.selection.main.head;n.state.doc.lineAt(i).text.trim().startsWith(">")&&(window.thoughtform.ai.handleAiChatRequest(n),s=!0)}break}s&&(o.preventDefault(),o.stopPropagation())},{capture:!0}))},100);
